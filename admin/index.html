<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
      body { font-family: Arial, sans-serif; padding: 24px; max-width: 1200px; }
      button { padding: 10px 14px; cursor: pointer; }
      input, select { padding: 8px; width: 100%; box-sizing: border-box; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .bar { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; }
      .msg { margin: 12px 0; color: #333; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { text-align: left; border-top: 1px solid #ddd; padding: 8px; vertical-align: top; }
      th { border-top: none; }
      .card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; margin-top: 18px; }
      .muted { color: #555; }

      .mapWrap { position: relative; width: 100%; max-width: 1100px; }
      .mapImg { width: 100%; height: auto; display: block; border: 1px solid #ddd; border-radius: 8px; }
      .mapLayer { position: absolute; inset: 0; }

      .unitBox {
        position: absolute;
        box-sizing: border-box;
        border-radius: 2px;
        cursor: pointer;
        pointer-events: auto;
      }

      .unitGreen { background: rgba(34,197,94,0.33); }
      .unitRed { background: rgba(239,68,68,0.33); }
      .unitYellow { background: rgba(234,179,8,0.33); }

      .btnSmall { padding: 6px 10px; }
    </style>
  </head>

  <body>
    <div class="bar">
      <h2 style="margin:0">Brakkerigg admin</h2>
      <button id="refreshBtn">Oppdater</button>
      <button id="logoutBtn">Logg ut</button>
      <span class="muted" id="who"></span>
    </div>

    <div class="msg" id="msg"></div>

    <div class="card">
      <h3 style="margin-top:0">Kart</h3>
      <div class="mapWrap" id="mapWrap">
        <img class="mapImg" src="/admin/kart.png" alt="Kart over enheter" />
        <div class="mapLayer" id="mapLayer"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Oversikt</h3>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Enhet</th>
              <th>Status</th>
              <th>Leietaker n책</th>
              <th>Firma</th>
              <th>Innflytting</th>
              <th>Utflytting</th>
              <th>Dager igjen</th>
              <th>Lengde n책</th>
              <th>Sum dager utleid ferdig</th>
              <th>Neste booking</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Ny booking</h3>
      <p class="muted">Minimum 7 netter. Utflytting er datoen de forlater enheten.</p>

      <form id="form">
        <div class="row">
          <div>
            <label>Enhet</label>
            <select id="unitId">
              <option value="">Velg</option>
            </select>
          </div>
          <div>
            <label>Firma</label>
            <input id="company" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Leietaker</label>
            <input id="tenantName" />
          </div>
          <div></div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Innflytting</label>
            <input id="checkinDate" type="date" />
          </div>
          <div>
            <label>Utflytting</label>
            <input id="checkoutDate" type="date" />
          </div>
        </div>

        <div style="margin-top:12px">
          <button type="submit">Opprett booking</button>
        </div>
      </form>
    </div>

    <script>
      const elMsg = document.getElementById("msg")
      const elTbody = document.getElementById("tbody")
      const elUnitSelect = document.getElementById("unitId")
      const elWho = document.getElementById("who")
      const elMapLayer = document.getElementById("mapLayer")

      function setMsg(t) {
        elMsg.textContent = t || ""
      }

      function isoToday() {
        const d = new Date()
        const mm = String(d.getMonth() + 1).padStart(2, "0")
        const dd = String(d.getDate()).padStart(2, "0")
        return d.getFullYear() + "-" + mm + "-" + dd
      }

      function daysBetween(a, b) {
        if (!a || !b) return ""
        const da = new Date(a)
        const db = new Date(b)
        const diff = Math.round((db - da) / (1000 * 60 * 60 * 24))
        return Number.isFinite(diff) ? diff : ""
      }

      function daysLeft(checkout) {
        if (!checkout) return ""
        return daysBetween(isoToday(), checkout)
      }

      function statusText(row) {
        if (row.current_booking_id) return "Utleid"
        if (row.next_checkin_date) return "Ledig, booket"
        return "Ledig"
      }

      function nextText(row) {
        if (!row.next_checkin_date) return ""
        return row.next_checkin_date + " til " + row.next_checkout_date
      }

      function clearTable() {
        elTbody.innerHTML = ""
      }

      function addRow(row) {
        const tr = document.createElement("tr")

        const lengthNow = row.current_checkin_date && row.current_checkout_date
          ? daysBetween(row.current_checkin_date, row.current_checkout_date)
          : ""

        const cells = [
          row.unit_code,
          statusText(row),
          row.current_tenant_name || "",
          row.current_company || "",
          row.current_checkin_date || "",
          row.current_checkout_date || "",
          row.current_checkout_date ? daysLeft(row.current_checkout_date) : "",
          lengthNow,
          row.total_days_completed || 0,
          nextText(row)
        ]

        for (const c of cells) {
          const td = document.createElement("td")
          td.textContent = c
          tr.appendChild(td)
        }

        const tdActions = document.createElement("td")

        if (row.current_booking_id) {
          const btn = document.createElement("button")
          btn.type = "button"
          btn.className = "btnSmall"
          btn.textContent = "Slett aktiv"
          btn.addEventListener("click", () => deleteBooking(Number(row.current_booking_id)))
          tdActions.appendChild(btn)
        }

        if (row.next_booking_id) {
          const btn2 = document.createElement("button")
          btn2.type = "button"
          btn2.className = "btnSmall"
          btn2.style.marginLeft = "8px"
          btn2.textContent = "Slett neste"
          btn2.addEventListener("click", () => deleteBooking(Number(row.next_booking_id)))
          tdActions.appendChild(btn2)
        }

        tr.appendChild(tdActions)
        elTbody.appendChild(tr)
      }

      function fillUnitSelect(rows) {
        elUnitSelect.innerHTML = '<option value="">Velg</option>'
        for (const r of rows) {
          const opt = document.createElement("option")
          opt.value = r.unit_id
          opt.textContent = r.unit_code
          elUnitSelect.appendChild(opt)
        }
      }

      function unitColorClass(row) {
        const today = isoToday()

        if (row.current_booking_id) return "unitRed"

        if (row.next_checkin_date) {
          if (today < row.next_checkin_date) return "unitYellow"
          return "unitRed"
        }

        return "unitGreen"
      }

      const ROW_1ETG_TOP = [101,103,105,107,109,111,113,115,117,119,121]
      const ROW_1ETG_BOT = [102,104,106,108,110,112,114,116,118,120,122]
      const ROW_2ETG_TOP = [201,203,205,207,209,211,213,215,217,219,221]
      const ROW_2ETG_BOT = [202,204,206,208,210,212,214,216,218,220,222]

      const UNIT_POS = {
        "101": { x: 38.55, y: 56.15 },
        "102": { x: 38.55, y: 70.77 },
        "103": { x: 43.09, y: 55.75 },
        "104": { x: 43.27, y: 70.64 },
        "105": { x: 47.73, y: 56.01 },
        "106": { x: 47.64, y: 70.77 },
        "107": { x: 52.91, y: 56.15 },
        "108": { x: 52.82, y: 70.77 },
        "109": { x: 58.00, y: 56.01 },
        "110": { x: 57.73, y: 70.64 },
        "111": { x: 63.18, y: 56.15 },
        "112": { x: 63.18, y: 70.77 },
        "113": { x: 67.82, y: 56.28 },
        "114": { x: 68.00, y: 71.04 },
        "115": { x: 73.09, y: 56.28 },
        "116": { x: 73.00, y: 71.04 },
        "117": { x: 78.55, y: 56.15 },
        "118": { x: 78.36, y: 71.04 },
        "119": { x: 84.18, y: 56.01 },
        "120": { x: 84.18, y: 70.77 },
        "121": { x: 90.27, y: 56.55 },
        "122": { x: 90.18, y: 70.90 },

        "201": { x: 37.82, y: 9.61 },
        "202": { x: 37.64, y: 24.10 },
        "203": { x: 42.27, y: 9.74 },
        "204": { x: 42.64, y: 24.10 },
        "205": { x: 47.00, y: 9.88 },
        "206": { x: 47.00, y: 23.97 },
        "207": { x: 52.27, y: 10.01 },
        "208": { x: 52.00, y: 23.97 },
        "209": { x: 57.27, y: 9.88 },
        "210": { x: 57.18, y: 24.10 },
        "211": { x: 62.36, y: 9.88 },
        "212": { x: 62.00, y: 24.10 },
        "213": { x: 67.00, y: 9.61 },
        "214": { x: 67.27, y: 24.50 },
        "215": { x: 72.36, y: 9.74 },
        "216": { x: 72.09, y: 24.24 },
        "217": { x: 77.73, y: 9.74 },
        "218": { x: 77.45, y: 24.63 },
        "219": { x: 83.73, y: 9.88 },
        "220": { x: 83.27, y: 24.37 },
        "221": { x: 89.27, y: 9.74 },
        "222": { x: 89.36, y: 24.50 }
      }

      function avg(nums) {
        if (!nums.length) return null
        let s = 0
        for (const n of nums) s += n
        return s / nums.length
      }

      function xyFor(code) {
        const p = UNIT_POS[String(code)]
        if (!p || typeof p.x !== "number" || typeof p.y !== "number") return null
        return p
      }

      function buildRectsFromCenters(rowTop, rowBot) {
        const cols = Math.max(rowTop.length, rowBot.length)
        if (!cols) return {}

        const xCenters = []
        for (let i = 0; i < cols; i++) {
          const a = xyFor(rowTop[i])
          const b = xyFor(rowBot[i])
          const xs = []
          if (a) xs.push(a.x)
          if (b) xs.push(b.x)
          const x = avg(xs)
          if (x == null) return {}
          xCenters.push(x)
        }

        const yTop = avg(rowTop.map(c => xyFor(c)).filter(Boolean).map(p => p.y))
        const yBot = avg(rowBot.map(c => xyFor(c)).filter(Boolean).map(p => p.y))
        if (yTop == null || yBot == null) return {}

        const yMid = (yTop + yBot) / 2
        const yTopOuter = 2 * yTop - yMid
        const yBotOuter = 2 * yBot - yMid

        const xWalls = []
        xWalls.push(xCenters[0] - (xCenters[1] - xCenters[0]) / 2)
        for (let i = 0; i < cols - 1; i++) {
          xWalls.push((xCenters[i] + xCenters[i + 1]) / 2)
        }
        xWalls.push(xCenters[cols - 1] + (xCenters[cols - 1] - xCenters[cols - 2]) / 2)

        const rects = {}

        for (let i = 0; i < cols; i++) {
          const left = xWalls[i]
          const right = xWalls[i + 1]
          const w = right - left

          const ct = rowTop[i]
          const cb = rowBot[i]

          if (ct != null) {
            rects[String(ct)] = { left, top: yTopOuter, width: w, height: (yMid - yTopOuter) }
          }
          if (cb != null) {
            rects[String(cb)] = { left, top: yMid, width: w, height: (yBotOuter - yMid) }
          }
        }

        return rects
      }

      function clampRect(r) {
        const left = Math.max(0, Math.min(100, r.left))
        const top = Math.max(0, Math.min(100, r.top))
        const width = Math.max(0, Math.min(100 - left, r.width))
        const height = Math.max(0, Math.min(100 - top, r.height))
        return { left, top, width, height }
      }

      const UNIT_RECT = Object.assign(
        {},
        buildRectsFromCenters(ROW_1ETG_TOP, ROW_1ETG_BOT),
        buildRectsFromCenters(ROW_2ETG_TOP, ROW_2ETG_BOT)
      )

      function renderMap(rows) {
        elMapLayer.innerHTML = ""

        for (const r of rows) {
          const code = String(r.unit_code || "")
          const raw = UNIT_RECT[code]
          if (!raw) continue
          const rect = clampRect(raw)

          const box = document.createElement("div")
          box.className = "unitBox " + unitColorClass(r)

          box.style.left = rect.left.toFixed(4) + "%"
          box.style.top = rect.top.toFixed(4) + "%"
          box.style.width = rect.width.toFixed(4) + "%"
          box.style.height = rect.height.toFixed(4) + "%"

          box.title = "Enhet " + code

          box.addEventListener("click", () => {
            const lines = []
            lines.push("Enhet " + code)
            lines.push(statusText(r))
            if (r.current_company) lines.push("Firma: " + r.current_company)
            if (r.current_tenant_name) lines.push("Leietaker: " + r.current_tenant_name)
            if (r.current_checkin_date) lines.push("Inn: " + r.current_checkin_date)
            if (r.current_checkout_date) lines.push("Ut: " + r.current_checkout_date)
            if (!r.current_booking_id && r.next_checkin_date) lines.push("Neste: " + nextText(r))
            alert(lines.join("\n"))
          })

          elMapLayer.appendChild(box)
        }
      }

      let identityReadyResolve
      const identityReady = new Promise((res) => { identityReadyResolve = res })

      async function authHeaders(extra = {}) {
        const ni = window.netlifyIdentity
        const user = ni && ni.currentUser ? ni.currentUser() : null
        if (!user || !user.jwt) return extra
        const token = await user.jwt()
        if (!token) return extra
        return { ...extra, Authorization: "Bearer " + token }
      }

      async function loadUnits() {
        setMsg("Henter data")
        clearTable()

        try {
          await identityReady
          const headers = await authHeaders()
          const res = await fetch("/.netlify/functions/units", { headers })

          if (res.status === 401 || res.status === 403) {
            window.location.href = "/login/"
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Klarte ikke 책 hente data. Status " + res.status))
            return
          }

          const rows = await res.json()
          const list = Array.isArray(rows) ? rows : []

          setMsg("")
          fillUnitSelect(list)
          renderMap(list)
          for (const rr of list) addRow(rr)
        } catch (e) {
          setMsg("Klarte ikke 책 hente data")
        }
      }

      async function createBooking(e) {
        e.preventDefault()
        setMsg("")

        const unitId = document.getElementById("unitId").value
        const tenantName = document.getElementById("tenantName").value
        const company = document.getElementById("company").value
        const checkinDate = document.getElementById("checkinDate").value
        const checkoutDate = document.getElementById("checkoutDate").value

        if (!unitId || !checkinDate || !checkoutDate) {
          setMsg("Fyll inn enhet og datoer")
          return
        }

        const len = daysBetween(checkinDate, checkoutDate)
        if (len < 7) {
          setMsg("Minimum leieperiode er 7 netter")
          return
        }

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/create-booking", {
            method: "POST",
            headers,
            body: JSON.stringify({
              unit_id: Number(unitId),
              tenant_name: tenantName,
              company: company,
              checkin_date: checkinDate,
              checkout_date: checkoutDate
            })
          })

          if (res.status === 401 || res.status === 403) {
            const t = await res.text()
            setMsg(t || "Ingen tilgang")
            return
          }

          if (res.status === 409) {
            setMsg("Konflikt. Enheten er allerede booket i perioden")
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || "Feil ved oppretting")
            return
          }

          setMsg("Booking opprettet")
          document.getElementById("tenantName").value = ""
          document.getElementById("company").value = ""
          document.getElementById("checkinDate").value = ""
          document.getElementById("checkoutDate").value = ""

          await loadUnits()
        } catch (e) {
          setMsg("Feil ved oppretting")
        }
      }

      async function deleteBooking(bookingId) {
        if (!Number.isFinite(bookingId) || bookingId <= 0) {
          setMsg("Mangler booking id")
          return
        }

        const ok = confirm("Vil du slette denne bookingen?")
        if (!ok) return

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/delete-booking", {
            method: "POST",
            headers,
            body: JSON.stringify({ booking_id: bookingId })
          })

          if (res.status === 401 || res.status === 403) {
            const t = await res.text()
            setMsg(t || "Ingen tilgang")
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Feil ved sletting. Status " + res.status))
            return
          }

          setMsg("Booking slettet")
          await loadUnits()
        } catch (e) {
          setMsg("Feil ved sletting")
        }
      }

      function logout() {
        const ni = window.netlifyIdentity
        if (!ni) return
        ni.logout()
        window.location.href = "/login/"
      }

      function initIdentity() {
        const ni = window.netlifyIdentity
        if (!ni) return

        ni.on("init", (user) => {
          if (!user) {
            window.location.href = "/login/"
            return
          }
          elWho.textContent = user.email || ""
          identityReadyResolve(user)
        })

        ni.on("logout", () => {
          window.location.href = "/login/"
        })

        ni.init()
      }

      document.getElementById("refreshBtn").addEventListener("click", loadUnits)
      document.getElementById("logoutBtn").addEventListener("click", logout)
      document.getElementById("form").addEventListener("submit", createBooking)

      initIdentity()
      identityReady.then(() => loadUnits())
    </script>
  </body>
</html>
