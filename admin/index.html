<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
      body { font-family: Arial, sans-serif; padding: 24px; max-width: 1200px; }
      button { padding: 10px 14px; cursor: pointer; }
      input, select, textarea { padding: 8px; width: 100%; box-sizing: border-box; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .bar { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; }
      .msg { margin: 12px 0; color: #333; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { text-align: left; border-top: 1px solid #ddd; padding: 8px; vertical-align: top; }
      th { border-top: none; }
      .card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; margin-top: 18px; }
      .muted { color: #555; }

      .mapWrap { position: relative; width: 100%; max-width: 1100px; }
      .mapImg { width: 100%; height: auto; display: block; border: 1px solid #ddd; border-radius: 8px; }
      .mapLayer { position: absolute; inset: 0; }

      .unitBox {
        position: absolute;
        box-sizing: border-box;
        border: 1px solid rgba(0,0,0,0.22);
        border-radius: 2px;
        cursor: pointer;
      }
      .unitGreen { background: rgba(34,197,94,0.35); }
      .unitRed { background: rgba(239,68,68,0.35); }
      .unitYellow { background: rgba(234,179,8,0.35); }
    </style>
  </head>

  <body>
    <div class="bar">
      <h2 style="margin:0">Brakkerigg admin</h2>
      <button id="refreshBtn">Oppdater</button>
      <button id="logoutBtn">Logg ut</button>
      <span class="muted" id="who"></span>
    </div>

    <div class="msg" id="msg"></div>

    <div class="card">
      <h3 style="margin-top:0">Kart</h3>

      <div class="mapWrap" id="mapWrap">
        <img class="mapImg" src="/admin/kart.png" alt="Kart over enheter" />
        <div class="mapLayer" id="mapLayer"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Oversikt</h3>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Enhet</th>
              <th>Status</th>
              <th>Leietaker n책</th>
              <th>Firma</th>
              <th>Innflytting</th>
              <th>Utflytting</th>
              <th>Dager igjen</th>
              <th>Lengde n책</th>
              <th>Sum dager utleid ferdig</th>
              <th>Neste booking</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Ny booking</h3>
      <p class="muted">Minimum 7 netter. Utflytting er datoen de forlater enheten.</p>

      <form id="form">
        <div class="row">
          <div>
            <label>Enhet</label>
            <select id="unitId">
              <option value="">Velg</option>
            </select>
          </div>
          <div>
            <label>Firma</label>
            <input id="company" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Leietaker</label>
            <input id="tenantName" />
          </div>
          <div></div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Innflytting</label>
            <input id="checkinDate" type="date" />
          </div>
          <div>
            <label>Utflytting</label>
            <input id="checkoutDate" type="date" />
          </div>
        </div>

        <div style="margin-top:12px">
          <button type="submit">Opprett booking</button>
        </div>
      </form>
    </div>

    <script>
      const elMsg = document.getElementById("msg")
      const elTbody = document.getElementById("tbody")
      const elUnitSelect = document.getElementById("unitId")
      const elWho = document.getElementById("who")
      const elMapLayer = document.getElementById("mapLayer")

      function setMsg(t) {
        elMsg.textContent = t || ""
      }

      function isoToday() {
        const d = new Date()
        const mm = String(d.getMonth() + 1).padStart(2, "0")
        const dd = String(d.getDate()).padStart(2, "0")
        return d.getFullYear() + "-" + mm + "-" + dd
      }

      function daysBetween(a, b) {
        if (!a || !b) return ""
        const da = new Date(a)
        const db = new Date(b)
        const diff = Math.round((db - da) / (1000 * 60 * 60 * 24))
        return Number.isFinite(diff) ? diff : ""
      }

      function daysLeft(checkout) {
        if (!checkout) return ""
        return daysBetween(isoToday(), checkout)
      }

      function statusText(row) {
        if (row.current_booking_id) return "Utleid"
        if (row.next_checkin_date) return "Ledig, booket"
        return "Ledig"
      }

      function nextText(row) {
        if (!row.next_checkin_date) return ""
        return row.next_checkin_date + " til " + row.next_checkout_date
      }

      function clearTable() {
        elTbody.innerHTML = ""
      }

      function addRow(row) {
        const tr = document.createElement("tr")

        const lengthNow = row.current_checkin_date && row.current_checkout_date
          ? daysBetween(row.current_checkin_date, row.current_checkout_date)
          : ""

        const cells = [
          row.unit_code,
          statusText(row),
          row.current_tenant_name || "",
          row.current_company || "",
          row.current_checkin_date || "",
          row.current_checkout_date || "",
          row.current_checkout_date ? daysLeft(row.current_checkout_date) : "",
          lengthNow,
          row.total_days_completed || 0,
          nextText(row)
        ]

        for (const c of cells) {
          const td = document.createElement("td")
          td.textContent = c
          tr.appendChild(td)
        }

        elTbody.appendChild(tr)
      }

      function fillUnitSelect(rows) {
        elUnitSelect.innerHTML = '<option value="">Velg</option>'
        for (const r of rows) {
          const opt = document.createElement("option")
          opt.value = r.unit_id
          opt.textContent = r.unit_code
          elUnitSelect.appendChild(opt)
        }
      }

      function unitColorClass(row) {
        const today = isoToday()

        if (row.current_booking_id) return "unitRed"

        if (row.next_checkin_date) {
          if (today < row.next_checkin_date) return "unitYellow"
          return "unitRed"
        }

        return "unitGreen"
      }

      function buildGridRects() {
        const rects = {}

        function addGrid(opts) {
          const cols = opts.cols
          const pitch = (opts.xEnd - opts.xStart) / (cols - 1)

          const w = pitch
          const rowGap = Math.abs(opts.yBottom - opts.yTop)
          const h = rowGap * 0.95

          function addRow(codes, yCenter) {
            for (let i = 0; i < cols; i++) {
              const code = String(codes[i])
              const cx = opts.xStart + pitch * i
              rects[code] = {
                left: cx - w / 2,
                top: yCenter - h / 2,
                width: w,
                height: h
              }
            }
          }

          addRow(opts.codesTop, opts.yTop)
          addRow(opts.codesBottom, opts.yBottom)
        }

        addGrid({
          cols: 11,
          xStart: 38.55,
          xEnd: 90.23,
          yTop: 56.25,
          yBottom: 70.80,
          codesTop: [101,103,105,107,109,111,113,115,117,119,121],
          codesBottom: [102,104,106,108,110,112,114,116,118,120,122]
        })

        addGrid({
          cols: 11,
          xStart: 37.73,
          xEnd: 89.32,
          yTop: 9.85,
          yBottom: 24.25,
          codesTop: [201,203,205,207,209,211,213,215,217,219,221],
          codesBottom: [202,204,206,208,210,212,214,216,218,220,222]
        })

        return rects
      }

      const UNIT_RECT = buildGridRects()

      function renderMap(rows) {
        elMapLayer.innerHTML = ""

        for (const r of rows) {
          const code = String(r.unit_code || "")
          const rect = UNIT_RECT[code]
          if (!rect) continue

          const box = document.createElement("div")
          box.className = "unitBox " + unitColorClass(r)
          box.style.left = rect.left + "%"
          box.style.top = rect.top + "%"
          box.style.width = rect.width + "%"
          box.style.height = rect.height + "%"
          box.title = "Enhet " + code

          box.addEventListener("click", () => {
            const lines = []
            lines.push("Enhet " + code)
            lines.push(statusText(r))
            if (r.current_company) lines.push("Firma: " + r.current_company)
            if (r.current_tenant_name) lines.push("Leietaker: " + r.current_tenant_name)
            if (r.current_checkin_date) lines.push("Inn: " + r.current_checkin_date)
            if (r.current_checkout_date) lines.push("Ut: " + r.current_checkout_date)
            if (!r.current_booking_id && r.next_checkin_date) lines.push("Neste: " + nextText(r))
            alert(lines.join("\n"))
          })

          elMapLayer.appendChild(box)
        }
      }

      let identityReadyResolve
      const identityReady = new Promise((res) => { identityReadyResolve = res })

      async function authHeaders(extra = {}) {
        const ni = window.netlifyIdentity
        const user = ni && ni.currentUser ? ni.currentUser() : null
        if (!user || !user.jwt) return extra
        const token = await user.jwt()
        if (!token) return extra
        return { ...extra, Authorization: "Bearer " + token }
      }

      async function loadUnits() {
        setMsg("Henter data")
        clearTable()

        try {
          await identityReady
          const headers = await authHeaders()
          const res = await fetch("/.netlify/functions/units", { headers })

          if (res.status === 401 || res.status === 403) {
            window.location.href = "/login/"
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Klarte ikke 책 hente data. Status " + res.status))
            return
          }

          const rows = await res.json()
          const lastRows = Array.isArray(rows) ? rows : []

          setMsg("")
          fillUnitSelect(lastRows)
          renderMap(lastRows)
          for (const r of lastRows) addRow(r)
        } catch (e) {
          setMsg("Klarte ikke 책 hente data")
        }
      }

      async function createBooking(e) {
        e.preventDefault()
        setMsg("")

        const unitId = document.getElementById("unitId").value
        const tenantName = document.getElementById("tenantName").value
        const company = document.getElementById("company").value
        const checkinDate = document.getElementById("checkinDate").value
        const checkoutDate = document.getElementById("checkoutDate").value

        if (!unitId || !checkinDate || !checkoutDate) {
          setMsg("Fyll inn enhet og datoer")
          return
        }

        const len = daysBetween(checkinDate, checkoutDate)
        if (len < 7) {
          setMsg("Minimum leieperiode er 7 netter")
          return
        }

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/create-booking", {
            method: "POST",
            headers,
            body: JSON.stringify({
              unit_id: Number(unitId),
              tenant_name: tenantName,
              company: company,
              checkin_date: checkinDate,
              checkout_date: checkoutDate
            })
          })

          if (res.status === 401 || res.status === 403) {
            const t = await res.text()
            setMsg(t || "Ingen tilgang")
            return
          }

          if (res.status === 409) {
            setMsg("Konflikt. Enheten er allerede booket i perioden")
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || "Feil ved oppretting")
            return
          }

          setMsg("Booking opprettet")
          document.getElementById("tenantName").value = ""
          document.getElementById("company").value = ""
          document.getElementById("checkinDate").value = ""
          document.getElementById("checkoutDate").value = ""

          await loadUnits()
        } catch (e) {
          setMsg("Feil ved oppretting")
        }
      }

      function logout() {
        const ni = window.netlifyIdentity
        if (!ni) return
        ni.logout()
        window.location.href = "/login/"
      }

      function initIdentity() {
        const ni = window.netlifyIdentity
        if (!ni) return

        ni.on("init", (user) => {
          if (!user) {
            window.location.href = "/login/"
            return
          }
          elWho.textContent = user.email || ""
          identityReadyResolve(user)
        })

        ni.on("logout", () => {
          window.location.href = "/login/"
        })

        ni.init()
      }

      document.getElementById("refreshBtn").addEventListener("click", loadUnits)
      document.getElementById("logoutBtn").addEventListener("click", logout)
      document.getElementById("form").addEventListener("submit", createBooking)

      initIdentity()
      identityReady.then(() => loadUnits())
    </script>
  </body>
</html>

