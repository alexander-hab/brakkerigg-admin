<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brakkerigg admin</title>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#0f172a;
        --muted:#64748b;
        --line:#e5e7eb;
        --shadow: 0 10px 25px rgba(15,23,42,0.06);
        --shadow2: 0 4px 12px rgba(15,23,42,0.06);
        --r: 14px;

        --green: rgba(34,197,94,0.30);
        --red: rgba(239,68,68,0.30);
        --yellow: rgba(234,179,8,0.30);
        --blue: rgba(59,130,246,0.32);
      }

      *{ box-sizing:border-box; }

      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .wrap{
        max-width: 1200px;
        margin: 0 auto;
        padding: 22px;
      }

      .topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:14px;
        margin-bottom: 18px;
      }

      .brand{
        display:flex;
        align-items:center;
        gap:12px;
        min-width: 240px;
      }

      .logo{
        height: 34px;
        width:auto;
        display:block;
        object-fit:contain;
      }

      .title{
        display:flex;
        flex-direction:column;
        gap:2px;
      }

      .title h1{
        font-size: 16px;
        margin:0;
        font-weight: 700;
        letter-spacing: 0.2px;
      }

      .title div{
        font-size: 12px;
        color: var(--muted);
      }

      .actions{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }

      .who{
        font-size: 12px;
        color: var(--muted);
        padding: 8px 10px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: #fff;
      }

      .btn{
        appearance:none;
        border: 1px solid var(--line);
        background: #fff;
        color: var(--text);
        border-radius: 10px;
        padding: 10px 12px;
        font-weight: 600;
        cursor:pointer;
        box-shadow: var(--shadow2);
      }

      .btn:hover{ filter: brightness(0.98); }
      .btn:active{ transform: translateY(1px); }

      .btnPrimary{
        background: #0f172a;
        color: #fff;
        border-color:#0f172a;
      }

      .btnDanger{
        background: #fff;
        border-color: rgba(239,68,68,0.35);
        color: #b91c1c;
      }

      .msg{
        margin: 0 0 14px 0;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
        color: var(--text);
        box-shadow: var(--shadow2);
        display:none;
      }

      .grid{
        display:grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }

      .card{
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--r);
        box-shadow: var(--shadow);
        padding: 14px;
      }

      .cardHead{
        display:flex;
        align-items:baseline;
        justify-content:space-between;
        gap: 12px;
        margin-bottom: 10px;
      }

      .cardHead h2{
        font-size: 14px;
        margin: 0;
        font-weight: 800;
        letter-spacing: 0.2px;
      }

      .cardHead .hint{
        font-size: 12px;
        color: var(--muted);
      }

      .mapWrap{ position: relative; width: 100%; max-width: 1100px; }
      .mapImg{
        width: 100%;
        height: auto;
        display:block;
        border: 1px solid var(--line);
        border-radius: 12px;
      }
      .mapLayer{ position:absolute; inset:0; }

      .unitBox{
        position:absolute;
        border-radius: 2px;
        cursor:pointer;
        pointer-events:auto;
        border: 1px solid rgba(2,6,23,0.12);
      }

      .unitGreen{ background: var(--green); }
      .unitRed{ background: var(--red); }
      .unitYellow{ background: var(--yellow); }
      .unitBlue{ background: var(--blue); }

      .tableWrap{
        overflow:auto;
        border: 1px solid var(--line);
        border-radius: 12px;
      }

      table{
        width: 100%;
        border-collapse: collapse;
        min-width: 980px;
        background:#fff;
      }

      thead th{
        position: sticky;
        top: 0;
        background: #fbfbfd;
        z-index: 1;
        font-size: 12px;
        color: #334155;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      th, td{
        text-align:left;
        border-top: 1px solid var(--line);
        padding: 10px 10px;
        vertical-align: top;
        font-size: 13px;
      }

      tbody tr:hover{
        background: #fafafa;
      }

      .pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background:#fff;
        font-size: 12px;
        color: #0f172a;
        white-space: nowrap;
      }

      .dot{
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #94a3b8;
      }

      .pillGreen .dot{ background: #22c55e; }
      .pillRed .dot{ background: #ef4444; }
      .pillYellow .dot{ background: #eab308; }

      .formGrid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      label{
        display:block;
        font-size: 12px;
        color: #334155;
        margin-bottom: 6px;
        font-weight: 600;
      }

      input, select{
        width:100%;
        padding: 10px 10px;
        border: 1px solid var(--line);
        border-radius: 10px;
        font-size: 14px;
        background: #fff;
        outline: none;
      }

      input:focus, select:focus{
        border-color: rgba(15,23,42,0.35);
        box-shadow: 0 0 0 4px rgba(15,23,42,0.08);
      }

      .formActions{
        margin-top: 12px;
        display:flex;
        gap:10px;
        align-items:center;
        justify-content:flex-start;
        flex-wrap:wrap;
      }

      .muted{
        color: var(--muted);
        font-size: 12px;
        margin: 0;
      }

      .btnSmall{
        padding: 6px 10px;
        border-radius: 10px;
        font-weight: 700;
        box-shadow: none;
      }

      .upLine{
        display:flex;
        gap: 8px;
        align-items:center;
        justify-content:space-between;
        margin-bottom: 6px;
      }

      .upText{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 340px;
        color:#0f172a;
      }

      .cleanHeadline{
        margin: 0 0 10px 0;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fbfbfd;
        font-weight: 900;
        font-size: 13px;
        color: var(--text);
      }

      @media (max-width: 860px){
        .formGrid{ grid-template-columns: 1fr; }
        .actions{ justify-content:flex-start; }
        .topbar{ flex-direction:column; align-items:flex-start; }
        table{ min-width: 920px; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <img class="logo" src="/admin/Hab.Logo.png" alt="HAB" />
          <div class="title">
            <h1>Brakkerigg</h1>
            <div>Oversikt, vask og booking</div>
          </div>
        </div>

        <div class="actions">
          <span class="who" id="who"></span>
          <button class="btn" id="refreshBtn" type="button">Oppdater</button>
          <button class="btn btnDanger" id="logoutBtn" type="button">Logg ut</button>
        </div>
      </div>

      <div class="msg" id="msg"></div>

      <div class="grid">
        <div class="card">
          <div class="cardHead">
            <h2>Kart</h2>
            <div class="hint">Klikk på et rom for detaljer</div>
          </div>
          <div class="mapWrap" id="mapWrap">
            <img class="mapImg" src="/admin/kart.png" alt="Kart over enheter" />
            <div class="mapLayer" id="mapLayer"></div>
          </div>
        </div>

        <div class="card">
          <div class="cardHead">
            <h2>Oversikt</h2>
            <div class="hint" id="accessHint"></div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Enhet</th>
                  <th>Status</th>
                  <th>Leietaker nå</th>
                  <th>Firma</th>
                  <th>Innflytting</th>
                  <th>Utflytting</th>
                  <th>Dager igjen</th>
                  <th>Lengde nå</th>
                  <th>Sum dager utleid ferdig</th>
                  <th>Kommende bookinger</th>
                  <th id="thActions">Handling</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" id="createCard">
          <div class="cardHead">
            <h2>Ny booking</h2>
            <div class="hint">Minimum 7 netter</div>
          </div>

          <p class="muted">Utflytting er datoen de forlater enheten.</p>

          <form id="form">
            <div class="formGrid">
              <div>
                <label>Enhet</label>
                <select id="unitId">
                  <option value="">Velg</option>
                </select>
              </div>
              <div>
                <label>Firma</label>
                <input id="company" />
              </div>
              <div>
                <label>Leietaker</label>
                <input id="tenantName" />
              </div>
              <div></div>
              <div>
                <label>Innflytting</label>
                <input id="checkinDate" type="date" />
              </div>
              <div>
                <label>Utflytting</label>
                <input id="checkoutDate" type="date" />
              </div>
            </div>

            <div class="formActions">
              <button class="btn btnPrimary" type="submit">Opprett booking</button>
            </div>
          </form>
        </div>

        <div class="card" id="cleanCard">
          <div class="cardHead">
            <h2>Vaskeliste</h2>
            <div class="hint" id="cleanHint"></div>
          </div>

          <div class="cleanHeadline" id="cleanMeta"></div>

          <div class="tableWrap">
            <table style="min-width:720px">
              <thead>
                <tr>
                  <th>Enhet</th>
                  <th>Årsak</th>
                  <th>Info</th>
                </tr>
              </thead>
              <tbody id="cleanBody"></tbody>
            </table>
          </div>

          <div style="height:12px"></div>

          <div class="cardHead" style="margin-bottom:10px">
            <h2>Kart, vask denne uka</h2>
            <div class="hint">Blå rom skal vaskes</div>
          </div>

          <div class="mapWrap" id="cleanMapWrap">
            <img class="mapImg" src="/admin/kart.png" alt="Kart vask" />
            <div class="mapLayer" id="cleanMapLayer"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const elMsg = document.getElementById("msg")
      const elTbody = document.getElementById("tbody")
      const elUnitSelect = document.getElementById("unitId")
      const elWho = document.getElementById("who")
      const elMapLayer = document.getElementById("mapLayer")
      const elCreateCard = document.getElementById("createCard")
      const elThActions = document.getElementById("thActions")
      const elAccessHint = document.getElementById("accessHint")

      const elCleanHint = document.getElementById("cleanHint")
      const elCleanMeta = document.getElementById("cleanMeta")
      const elCleanBody = document.getElementById("cleanBody")
      const elCleanMapLayer = document.getElementById("cleanMapLayer")

      let IS_ADMIN = false

      const CLEANING_CFG = {
        weekday: 1,
        hour: 8,
        minute: 0,
        floor1On: "odd"
      }

      function setMsg(t) {
        if (!t) {
          elMsg.textContent = ""
          elMsg.style.display = "none"
          return
        }
        elMsg.textContent = t
        elMsg.style.display = "block"
      }

      function isoToday() {
        const d = new Date()
        const mm = String(d.getMonth() + 1).padStart(2, "0")
        const dd = String(d.getDate()).padStart(2, "0")
        return d.getFullYear() + "-" + mm + "-" + dd
      }

      function toIsoDateLocal(d) {
        const y = d.getFullYear()
        const m = String(d.getMonth() + 1).padStart(2, "0")
        const day = String(d.getDate()).padStart(2, "0")
        return y + "-" + m + "-" + day
      }

      function fmtDate(s) {
        if (!s) return ""
        if (typeof s !== "string") return String(s)
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/)
        if (!m) return s
        return m[3] + "-" + m[2] + "-" + m[1]
      }

      function fmtRange(a, b) {
        const aa = fmtDate(a)
        const bb = fmtDate(b)
        if (!aa && !bb) return ""
        if (!aa) return bb
        if (!bb) return aa
        return aa + " til " + bb
      }

      function daysBetween(a, b) {
        if (!a || !b) return ""
        const da = new Date(a)
        const db = new Date(b)
        const diff = Math.round((db - da) / (1000 * 60 * 60 * 24))
        return Number.isFinite(diff) ? diff : ""
      }

      function daysLeft(checkout) {
        if (!checkout) return ""
        return daysBetween(isoToday(), checkout)
      }

      function safeJsonParseArray(x) {
        if (Array.isArray(x)) return x
        if (typeof x !== "string") return []
        try {
          const p = JSON.parse(x)
          return Array.isArray(p) ? p : []
        } catch {
          return []
        }
      }

      function getUpcoming(row) {
        const up = safeJsonParseArray(row.upcoming_bookings)
        up.sort((a, b) => String(a.checkin_date || "").localeCompare(String(b.checkin_date || "")))
        return up
      }

      function unitColorClass(row) {
        const today = isoToday()
        if (row.current_booking_id) return "unitRed"

        const up = getUpcoming(row)
        const nextStart = up[0] ? up[0].checkin_date : null

        if (nextStart) {
          if (today < nextStart) return "unitYellow"
          return "unitRed"
        }
        return "unitGreen"
      }

      function statusPill(row) {
        const pill = document.createElement("span")
        const cls = unitColorClass(row)
        const dot = document.createElement("span")
        dot.className = "dot"
        pill.appendChild(dot)

        let text = "Ledig"
        pill.className = "pill"
        if (cls === "unitRed") { pill.className += " pillRed"; text = "Utleid" }
        else if (cls === "unitYellow") { pill.className += " pillYellow"; text = "Ledig, booket" }
        else { pill.className += " pillGreen"; text = "Ledig" }

        pill.appendChild(document.createTextNode(text))
        return pill
      }

      function clearTable() {
        elTbody.innerHTML = ""
      }

      function upcomingCell(row) {
        const td = document.createElement("td")
        const up = getUpcoming(row)

        if (up.length === 0) {
          td.textContent = ""
          return td
        }

        const wrap = document.createElement("div")

        for (const b of up) {
          const line = document.createElement("div")
          line.className = "upLine"

          const txt = document.createElement("div")
          txt.className = "upText"
          const who = (b.company || b.tenant_name) ? (" " + (b.company || b.tenant_name)) : ""
          txt.textContent = fmtRange(b.checkin_date || "", b.checkout_date || "") + who

          line.appendChild(txt)

          if (IS_ADMIN) {
            const del = document.createElement("button")
            del.type = "button"
            del.className = "btn btnSmall btnDanger"
            del.textContent = "Slett"
            del.addEventListener("click", () => deleteBooking(Number(b.id)))
            line.appendChild(del)
          }

          wrap.appendChild(line)
        }

        td.appendChild(wrap)
        return td
      }

      function addRow(row) {
        const tr = document.createElement("tr")

        const lengthNow = row.current_checkin_date && row.current_checkout_date
          ? daysBetween(row.current_checkin_date, row.current_checkout_date)
          : ""

        const tdUnit = document.createElement("td")
        tdUnit.textContent = row.unit_code || ""
        tr.appendChild(tdUnit)

        const tdStatus = document.createElement("td")
        tdStatus.appendChild(statusPill(row))
        tr.appendChild(tdStatus)

        const tdTenant = document.createElement("td")
        tdTenant.textContent = row.current_tenant_name || ""
        tr.appendChild(tdTenant)

        const tdCompany = document.createElement("td")
        tdCompany.textContent = row.current_company || ""
        tr.appendChild(tdCompany)

        const tdIn = document.createElement("td")
        tdIn.textContent = fmtDate(row.current_checkin_date || "")
        tr.appendChild(tdIn)

        const tdOut = document.createElement("td")
        tdOut.textContent = fmtDate(row.current_checkout_date || "")
        tr.appendChild(tdOut)

        const tdLeft = document.createElement("td")
        tdLeft.textContent = row.current_checkout_date ? daysLeft(row.current_checkout_date) : ""
        tr.appendChild(tdLeft)

        const tdLen = document.createElement("td")
        tdLen.textContent = lengthNow
        tr.appendChild(tdLen)

        const tdTotal = document.createElement("td")
        tdTotal.textContent = row.total_days_completed || 0
        tr.appendChild(tdTotal)

        tr.appendChild(upcomingCell(row))

        if (IS_ADMIN) {
          const tdActions = document.createElement("td")
          if (row.current_booking_id) {
            const btn = document.createElement("button")
            btn.type = "button"
            btn.className = "btn btnSmall btnDanger"
            btn.textContent = "Slett aktiv"
            btn.addEventListener("click", () => deleteBooking(Number(row.current_booking_id)))
            tdActions.appendChild(btn)
          }
          tr.appendChild(tdActions)
        }

        elTbody.appendChild(tr)
      }

      function fillUnitSelect(rows) {
        elUnitSelect.innerHTML = '<option value="">Velg</option>'
        for (const r of rows) {
          const opt = document.createElement("option")
          opt.value = r.unit_id
          opt.textContent = r.unit_code
          elUnitSelect.appendChild(opt)
        }
      }

      const ROW_1ETG_TOP = [101,103,105,107,109,111,113,115,117,119,121]
      const ROW_1ETG_BOT = [102,104,106,108,110,112,114,116,118,120,122]
      const ROW_2ETG_TOP = [201,203,205,207,209,211,213,215,217,219,221]
      const ROW_2ETG_BOT = [202,204,206,208,210,212,214,216,218,220,222]

      const FLOOR1 = [...ROW_1ETG_TOP, ...ROW_1ETG_BOT].map(String).sort((a,b)=>Number(a)-Number(b))
      const FLOOR2 = [...ROW_2ETG_TOP, ...ROW_2ETG_BOT].map(String).sort((a,b)=>Number(a)-Number(b))

      const UNIT_POS = {
        "101": { x: 38.55, y: 56.15 },
        "102": { x: 38.55, y: 70.77 },
        "103": { x: 43.09, y: 55.75 },
        "104": { x: 43.27, y: 70.64 },
        "105": { x: 47.73, y: 56.01 },
        "106": { x: 47.64, y: 70.77 },
        "107": { x: 52.91, y: 56.15 },
        "108": { x: 52.82, y: 70.77 },
        "109": { x: 58.00, y: 56.01 },
        "110": { x: 57.73, y: 70.64 },
        "111": { x: 63.18, y: 56.15 },
        "112": { x: 63.18, y: 70.77 },
        "113": { x: 67.82, y: 56.28 },
        "114": { x: 68.00, y: 71.04 },
        "115": { x: 73.09, y: 56.28 },
        "116": { x: 73.00, y: 71.04 },
        "117": { x: 78.55, y: 56.15 },
        "118": { x: 78.36, y: 71.04 },
        "119": { x: 84.18, y: 56.01 },
        "120": { x: 84.18, y: 70.77 },
        "121": { x: 90.27, y: 56.55 },
        "122": { x: 90.18, y: 70.90 },

        "201": { x: 37.82, y: 9.61 },
        "202": { x: 37.64, y: 24.10 },
        "203": { x: 42.27, y: 9.74 },
        "204": { x: 42.64, y: 24.10 },
        "205": { x: 47.00, y: 9.88 },
        "206": { x: 47.00, y: 23.97 },
        "207": { x: 52.27, y: 10.01 },
        "208": { x: 52.00, y: 23.97 },
        "209": { x: 57.27, y: 9.88 },
        "210": { x: 57.18, y: 24.10 },
        "211": { x: 62.36, y: 9.88 },
        "212": { x: 62.00, y: 24.10 },
        "213": { x: 67.00, y: 9.61 },
        "214": { x: 67.27, y: 24.50 },
        "215": { x: 72.36, y: 9.74 },
        "216": { x: 72.09, y: 24.24 },
        "217": { x: 77.73, y: 9.74 },
        "218": { x: 77.45, y: 24.63 },
        "219": { x: 83.73, y: 9.88 },
        "220": { x: 83.27, y: 24.37 },
        "221": { x: 89.27, y: 9.74 },
        "222": { x: 89.36, y: 24.50 }
      }

      function avg(nums) {
        if (!nums.length) return null
        let s = 0
        for (const n of nums) s += n
        return s / nums.length
      }

      function xyFor(code) {
        const p = UNIT_POS[String(code)]
        if (!p || typeof p.x !== "number" || typeof p.y !== "number") return null
        return p
      }

      function buildRectsFromCenters(rowTop, rowBot) {
        const cols = Math.max(rowTop.length, rowBot.length)
        if (!cols) return {}

        const xCenters = []
        for (let i = 0; i < cols; i++) {
          const a = xyFor(rowTop[i])
          const b = xyFor(rowBot[i])
          const xs = []
          if (a) xs.push(a.x)
          if (b) xs.push(b.x)
          const x = avg(xs)
          if (x == null) return {}
          xCenters.push(x)
        }

        const yTop = avg(rowTop.map(c => xyFor(c)).filter(Boolean).map(p => p.y))
        const yBot = avg(rowBot.map(c => xyFor(c)).filter(Boolean).map(p => p.y))
        if (yTop == null || yBot == null) return {}

        const yMid = (yTop + yBot) / 2
        const yTopOuter = 2 * yTop - yMid
        const yBotOuter = 2 * yBot - yMid

        const xWalls = []
        xWalls.push(xCenters[0] - (xCenters[1] - xCenters[0]) / 2)
        for (let i = 0; i < cols - 1; i++) {
          xWalls.push((xCenters[i] + xCenters[i + 1]) / 2)
        }
        xWalls.push(xCenters[cols - 1] + (xCenters[cols - 1] - xCenters[cols - 2]) / 2)

        const rects = {}

        for (let i = 0; i < cols; i++) {
          const left = xWalls[i]
          const right = xWalls[i + 1]
          const w = right - left

          const ct = rowTop[i]
          const cb = rowBot[i]

          if (ct != null) rects[String(ct)] = { left, top: yTopOuter, width: w, height: (yMid - yTopOuter) }
          if (cb != null) rects[String(cb)] = { left, top: yMid, width: w, height: (yBotOuter - yMid) }
        }

        return rects
      }

      function clampRect(r) {
        const left = Math.max(0, Math.min(100, r.left))
        const top = Math.max(0, Math.min(100, r.top))
        const width = Math.max(0, Math.min(100 - left, r.width))
        const height = Math.max(0, Math.min(100 - top, r.height))
        return { left, top, width, height }
      }

      const UNIT_RECT = Object.assign(
        {},
        buildRectsFromCenters(ROW_1ETG_TOP, ROW_1ETG_BOT),
        buildRectsFromCenters(ROW_2ETG_TOP, ROW_2ETG_BOT)
      )

      function renderMap(rows) {
        elMapLayer.innerHTML = ""

        for (const r of rows) {
          const code = String(r.unit_code || "")
          const raw = UNIT_RECT[code]
          if (!raw) continue
          const rect = clampRect(raw)

          const box = document.createElement("div")
          box.className = "unitBox " + unitColorClass(r)

          box.style.left = rect.left.toFixed(4) + "%"
          box.style.top = rect.top.toFixed(4) + "%"
          box.style.width = rect.width.toFixed(4) + "%"
          box.style.height = rect.height.toFixed(4) + "%"

          box.title = "Enhet " + code

          box.addEventListener("click", () => {
            const lines = []
            lines.push("Enhet " + code)
            lines.push(statusPill(r).textContent || "")
            if (r.current_company) lines.push("Firma: " + r.current_company)
            if (r.current_tenant_name) lines.push("Leietaker: " + r.current_tenant_name)
            if (r.current_checkin_date) lines.push("Inn: " + fmtDate(r.current_checkin_date))
            if (r.current_checkout_date) lines.push("Ut: " + fmtDate(r.current_checkout_date))

            const up = getUpcoming(r)
            if (!r.current_booking_id && up.length > 0) {
              lines.push("Kommende:")
              for (let i = 0; i < Math.min(6, up.length); i++) {
                const b = up[i]
                const who = (b.company || b.tenant_name) ? (" " + (b.company || b.tenant_name)) : ""
                lines.push(fmtRange(b.checkin_date || "", b.checkout_date || "") + who)
              }
            }

            alert(lines.join("\n"))
          })

          elMapLayer.appendChild(box)
        }
      }

      function renderCleaningMap(cleanSet) {
        elCleanMapLayer.innerHTML = ""
        const codes = Array.from(cleanSet || []).map(String)

        for (const code of codes) {
          const raw = UNIT_RECT[code]
          if (!raw) continue
          const rect = clampRect(raw)

          const box = document.createElement("div")
          box.className = "unitBox unitBlue"

          box.style.left = rect.left.toFixed(4) + "%"
          box.style.top = rect.top.toFixed(4) + "%"
          box.style.width = rect.width.toFixed(4) + "%"
          box.style.height = rect.height.toFixed(4) + "%"

          box.title = "Skal vaskes: " + code

          box.addEventListener("click", () => {
            alert("Skal vaskes denne uka: " + code)
          })

          elCleanMapLayer.appendChild(box)
        }
      }

      function isoWeekNumber(d) {
        const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()))
        const dayNum = date.getUTCDay() || 7
        date.setUTCDate(date.getUTCDate() + 4 - dayNum)
        const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1))
        return Math.ceil((((date - yearStart) / 86400000) + 1) / 7)
      }

      function nextCleaningDate(now) {
        const wd = CLEANING_CFG.weekday
        const h = CLEANING_CFG.hour
        const m = CLEANING_CFG.minute

        const candidate = new Date(now)
        candidate.setHours(h, m, 0, 0)

        let addDays = (wd - now.getDay() + 7) % 7
        if (addDays === 0 && now.getTime() >= candidate.getTime()) addDays = 7

        const next = new Date(now)
        next.setDate(now.getDate() + addDays)
        next.setHours(h, m, 0, 0)
        return next
      }

      function floorForCleaning(d) {
        const w = isoWeekNumber(d)
        const odd = (w % 2) === 1
        if (CLEANING_CFG.floor1On === "odd") return odd ? 1 : 2
        return odd ? 2 : 1
      }

      async function loadCleaningPlan() {
        const now = new Date()
        const next = nextCleaningDate(now)
        const prev = new Date(next.getTime() - 7 * 24 * 60 * 60 * 1000)

        const floor = floorForCleaning(next)
        const floorUnits = floor === 1 ? FLOOR1 : FLOOR2

        const startIso = toIsoDateLocal(prev)
        const endIso = toIsoDateLocal(next)

        elCleanHint.textContent = "Vaskedag: " + fmtDate(endIso)

        let moved = []
        try {
          const headers = await authHeaders()
          const res = await fetch("/.netlify/functions/cleaning-plan?start=" + startIso + "&end=" + endIso, { headers })
          if (res.ok) moved = await res.json()
        } catch {}

        const movedMap = new Map()
        for (const r of (Array.isArray(moved) ? moved : [])) {
          const code = String(r.unit_code || "")
          if (!code) continue
          if (!movedMap.has(code)) movedMap.set(code, r)
        }

        const plan = new Map()
        for (const code of floorUnits) {
          plan.set(code, { code, reason: "Ukevask " + floor + ". etg", info: "" })
        }

        let movedExtra = 0
        for (const [code, r] of movedMap.entries()) {
          const who = (r.company || r.tenant_name) ? (" " + (r.company || r.tenant_name)) : ""
          const info = "Utflytting: " + fmtDate(r.checkout_date || "") + who

          if (plan.has(code)) {
            const cur = plan.get(code)
            cur.info = cur.info ? (cur.info + ". " + info) : info
          } else {
            movedExtra += 1
            plan.set(code, { code, reason: "Utflytt-vask", info })
          }
        }

        elCleanMeta.textContent =
          "Periode for utflytt-vask: " + fmtDate(startIso) + " til " + fmtDate(endIso) +
          ". Etasje denne uka: " + floor + ". Ekstra utflytt-vask: " + movedExtra + "."

        elCleanBody.innerHTML = ""
        const items = Array.from(plan.values()).sort((a, b) => Number(a.code) - Number(b.code))

        for (const it of items) {
          const tr = document.createElement("tr")

          const tdA = document.createElement("td")
          tdA.textContent = it.code
          tr.appendChild(tdA)

          const tdB = document.createElement("td")
          tdB.textContent = it.reason
          tr.appendChild(tdB)

          const tdC = document.createElement("td")
          tdC.textContent = it.info || ""
          tr.appendChild(tdC)

          elCleanBody.appendChild(tr)
        }

        const cleanSet = new Set(items.map(x => String(x.code)))
        renderCleaningMap(cleanSet)
      }

      let identityReadyResolve
      const identityReady = new Promise((res) => { identityReadyResolve = res })

      async function authHeaders(extra = {}) {
        const ni = window.netlifyIdentity
        const user = ni && ni.currentUser ? ni.currentUser() : null
        if (!user || !user.jwt) return extra
        const token = await user.jwt()
        if (!token) return extra
        return { ...extra, Authorization: "Bearer " + token }
      }

      function computeIsAdmin(user) {
        const rolesRaw = user?.app_metadata?.roles || []
        const roles = Array.isArray(rolesRaw) ? rolesRaw.map(r => String(r).toLowerCase()) : []
        return roles.includes("admin")
      }

      function applyAccessUI() {
        if (IS_ADMIN) {
          elAccessHint.textContent = "Admin"
          elCreateCard.style.display = "block"
          elThActions.style.display = ""
        } else {
          elAccessHint.textContent = "Lesetilgang"
          elCreateCard.style.display = "none"
          elThActions.style.display = "none"
        }
      }

      async function loadUnits() {
        setMsg("Henter data")

        try {
          await identityReady
          const headers = await authHeaders()
          const res = await fetch("/.netlify/functions/units", { headers })

          if (res.status === 401) {
            window.location.href = "/login/"
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Klarte ikke å hente data. Status " + res.status))
            return
          }

          const rows = await res.json()
          const list = Array.isArray(rows) ? rows : []

          setMsg("")
          clearTable()
          fillUnitSelect(list)
          renderMap(list)
          for (const rr of list) addRow(rr)

          await loadCleaningPlan()
        } catch {
          setMsg("Klarte ikke å hente data")
        }
      }

      async function createBooking(e) {
        e.preventDefault()
        if (!IS_ADMIN) {
          setMsg("Du har ikke rettigheter til å opprette booking")
          return
        }

        setMsg("")

        const unitId = document.getElementById("unitId").value
        const tenantName = document.getElementById("tenantName").value
        const company = document.getElementById("company").value
        const checkinDate = document.getElementById("checkinDate").value
        const checkoutDate = document.getElementById("checkoutDate").value

        if (!unitId || !checkinDate || !checkoutDate) {
          setMsg("Fyll inn enhet og datoer")
          return
        }

        const len = daysBetween(checkinDate, checkoutDate)
        if (len < 7) {
          setMsg("Minimum leieperiode er 7 netter")
          return
        }

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/create-booking", {
            method: "POST",
            headers,
            body: JSON.stringify({
              unit_id: Number(unitId),
              tenant_name: tenantName,
              company: company,
              checkin_date: checkinDate,
              checkout_date: checkoutDate
            })
          })

          if (res.status === 401 || res.status === 403) {
            const t = await res.text()
            setMsg(t || "Ingen tilgang")
            return
          }

          if (res.status === 409) {
            setMsg("Konflikt. Enheten er allerede booket i perioden")
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || "Feil ved oppretting")
            return
          }

          setMsg("Booking opprettet")
          document.getElementById("tenantName").value = ""
          document.getElementById("company").value = ""
          document.getElementById("checkinDate").value = ""
          document.getElementById("checkoutDate").value = ""

          await loadUnits()
        } catch {
          setMsg("Feil ved oppretting")
        }
      }

      async function deleteBooking(bookingId) {
        if (!IS_ADMIN) {
          setMsg("Du har ikke rettigheter til å slette booking")
          return
        }

        if (!Number.isFinite(bookingId) || bookingId <= 0) {
          setMsg("Mangler booking id")
          return
        }

        const ok = confirm("Vil du slette denne bookingen?")
        if (!ok) return

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/delete-booking", {
            method: "POST",
            headers,
            body: JSON.stringify({ booking_id: bookingId })
          })

          if (res.status === 401 || res.status === 403) {
            const t = await res.text()
            setMsg(t || "Ingen tilgang")
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Feil ved sletting. Status " + res.status))
            return
          }

          setMsg("Booking slettet")
          await loadUnits()
        } catch {
          setMsg("Feil ved sletting")
        }
      }

      function logout() {
        const ni = window.netlifyIdentity
        if (!ni) return
        ni.logout()
        window.location.href = "/login/"
      }

      function initIdentity() {
        const ni = window.netlifyIdentity
        if (!ni) return

        ni.on("init", (user) => {
          if (!user) {
            window.location.href = "/login/"
            return
          }

          IS_ADMIN = computeIsAdmin(user)
          elWho.textContent = user.email || ""
          applyAccessUI()

          identityReadyResolve(user)
        })

        ni.on("logout", () => {
          window.location.href = "/login/"
        })

        ni.init()
      }

      document.getElementById("refreshBtn").addEventListener("click", loadUnits)
      document.getElementById("logoutBtn").addEventListener("click", logout)
      document.getElementById("form").addEventListener("submit", createBooking)

      initIdentity()
      identityReady.then(() => loadUnits())
    </script>
  </body>
</html>
