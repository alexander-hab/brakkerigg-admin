<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
      body { font-family: Arial, sans-serif; padding: 24px; max-width: 1200px; }
      button { padding: 10px 14px; cursor: pointer; }
      input, select, textarea { padding: 8px; width: 100%; box-sizing: border-box; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .bar { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; }
      .msg { margin: 12px 0; color: #333; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { text-align: left; border-top: 1px solid #ddd; padding: 8px; vertical-align: top; }
      th { border-top: none; }
      .card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; margin-top: 18px; }
      .muted { color: #555; }

      .mapWrap { position: relative; width: 100%; max-width: 1100px; }
      .mapImg { width: 100%; height: auto; display: block; border: 1px solid #ddd; border-radius: 8px; }
      .mapLayer { position: absolute; inset: 0; }

      .unitDot {
        position: absolute;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid rgba(0,0,0,0.25);
        transform: translate(-50%, -50%);
        cursor: pointer;
      }

      .unitGreen { background: #22c55e; }
      .unitYellow { background: #eab308; }
      .unitRed { background: #ef4444; }

      .pickGrid { display: grid; grid-template-columns: 160px 1fr; gap: 10px; align-items: center; margin-top: 12px; }
      .pickRow { display: grid; grid-template-columns: 1fr 160px; gap: 10px; }
      .small { font-size: 12px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>
  <body>
    <div class="bar">
      <h2 style="margin:0">Brakkerigg admin</h2>
      <button id="refreshBtn">Oppdater</button>
      <button id="logoutBtn">Logg ut</button>
      <span class="muted" id="who"></span>
    </div>

    <div class="msg" id="msg"></div>

    <div class="card">
      <h3 style="margin-top:0">Kart</h3>

      <div class="mapWrap" id="mapWrap">
        <img class="mapImg" src="/admin/kart.png" alt="Kart over enheter" />
        <div class="mapLayer" id="mapLayer"></div>
      </div>

      <div class="pickGrid">
        <div class="muted small">Slik setter du posisjon</div>
        <div class="small">
          Skriv enhetskode. Trykk Aktiver. Klikk på kartet der enheten ligger. Linjen blir lagt i feltet under.
        </div>
      </div>

      <div class="pickRow" style="margin-top:10px">
        <input id="pickUnitCode" placeholder="Enhet, f.eks 101 eller 215" />
        <button id="pickToggleBtn" type="button">Aktiver plassering</button>
      </div>

      <div class="muted small" style="margin-top:10px">
        Kopier linjene under og lim de inn i UNIT_POS i koden når du er ferdig.
      </div>
      <textarea id="pickOutput" class="mono" rows="6" readonly placeholder="Klikk på kartet når plassering er aktiv"></textarea>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Oversikt</h3>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Enhet</th>
              <th>Status</th>
              <th>Leietaker nå</th>
              <th>Firma</th>
              <th>Innflytting</th>
              <th>Utflytting</th>
              <th>Dager igjen</th>
              <th>Lengde nå</th>
              <th>Sum dager utleid ferdig</th>
              <th>Neste booking</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Ny booking</h3>
      <p class="muted">Minimum 7 netter. Utflytting er datoen de forlater enheten.</p>

      <form id="form">
        <div class="row">
          <div>
            <label>Enhet</label>
            <select id="unitId">
              <option value="">Velg</option>
            </select>
          </div>
          <div>
            <label>Firma</label>
            <input id="company" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Leietaker</label>
            <input id="tenantName" />
          </div>
          <div></div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Innflytting</label>
            <input id="checkinDate" type="date" />
          </div>
          <div>
            <label>Utflytting</label>
            <input id="checkoutDate" type="date" />
          </div>
        </div>

        <div style="margin-top:12px">
          <button type="submit">Opprett booking</button>
        </div>
      </form>
    </div>

    <script>
      const elMsg = document.getElementById("msg")
      const elTbody = document.getElementById("tbody")
      const elUnitSelect = document.getElementById("unitId")
      const elWho = document.getElementById("who")

      const elMapWrap = document.getElementById("mapWrap")
      const elMapLayer = document.getElementById("mapLayer")
      const elPickUnitCode = document.getElementById("pickUnitCode")
      const elPickToggleBtn = document.getElementById("pickToggleBtn")
      const elPickOutput = document.getElementById("pickOutput")

      function setMsg(t) {
        elMsg.textContent = t || ""
      }

      function isoToday() {
        const d = new Date()
        const mm = String(d.getMonth() + 1).padStart(2, "0")
        const dd = String(d.getDate()).padStart(2, "0")
        return d.getFullYear() + "-" + mm + "-" + dd
      }

      function daysBetween(a, b) {
        if (!a || !b) return ""
        const da = new Date(a)
        const db = new Date(b)
        const diff = Math.round((db - da) / (1000 * 60 * 60 * 24))
        return Number.isFinite(diff) ? diff : ""
      }

      function daysLeft(checkout) {
        if (!checkout) return ""
        return daysBetween(isoToday(), checkout)
      }

      function statusText(row) {
        if (row.current_booking_id) return "Utleid"
        if (row.next_checkin_date) return "Ledig, booket"
        return "Ledig"
      }

      function nextText(row) {
        if (!row.next_checkin_date) return ""
        return row.next_checkin_date + " til " + row.next_checkout_date
      }

      function clearTable() {
        elTbody.innerHTML = ""
      }

      function addRow(row) {
        const tr = document.createElement("tr")

        const lengthNow = row.current_checkin_date && row.current_checkout_date
          ? daysBetween(row.current_checkin_date, row.current_checkout_date)
          : ""

        const cells = [
          row.unit_code,
          statusText(row),
          row.current_tenant_name || "",
          row.current_company || "",
          row.current_checkin_date || "",
          row.current_checkout_date || "",
          row.current_checkout_date ? daysLeft(row.current_checkout_date) : "",
          lengthNow,
          row.total_days_completed || 0,
          nextText(row)
        ]

        for (const c of cells) {
          const td = document.createElement("td")
          td.textContent = c
          tr.appendChild(td)
        }

        elTbody.appendChild(tr)
      }

      function fillUnitSelect(rows) {
        elUnitSelect.innerHTML = '<option value="">Velg</option>'
        for (const r of rows) {
          const opt = document.createElement("option")
          opt.value = r.unit_id
          opt.textContent = r.unit_code
          elUnitSelect.appendChild(opt)
        }
      }

      function unitColorClass(row) {
        const today = isoToday()

        if (row.current_booking_id) return "unitRed"

        if (row.next_checkin_date) {
          if (String(today) < String(row.next_checkin_date)) return "unitYellow"
          return "unitRed"
        }

        return "unitGreen"
      }

      const UNIT_POS = {
        "101": { x: 38.55, y: 56.15 },
        "102": { x: 38.55, y: 70.77 },
        "103": { x: 43.09, y: 55.75 },
        "104": { x: 43.27, y: 70.64 },
        "105": { x: 47.73, y: 56.01 },
        "106": { x: 47.64, y: 70.77 },
        "107": { x: 52.91, y: 56.15 },
        "108": { x: 52.82, y: 70.77 },
        "109": { x: 58.00, y: 56.01 },
        "110": { x: 57.73, y: 70.64 },
        "111": { x: 63.18, y: 56.15 },
        "112": { x: 63.18, y: 70.77 },
        "113": { x: 67.82, y: 56.28 },
        "114": { x: 68.00, y: 71.04 },
        "115": { x: 73.09, y: 56.28 },
        "116": { x: 73.00, y: 71.04 },
        "117": { x: 78.55, y: 56.15 },
        "118": { x: 78.36, y: 71.04 },
        "119": { x: 84.18, y: 56.01 },
        "120": { x: 84.18, y: 70.77 },
        "121": { x: 90.27, y: 56.55 },
        "122": { x: 90.18, y: 70.90 },
        "201": { x: 37.82, y: 9.61 },
        "202": { x: 37.64, y: 24.10 },
        "203": { x: 42.27, y: 9.74 },
        "204": { x: 42.64, y: 24.10 },
        "205": { x: 47.00, y: 9.88 },
        "206": { x: 47.00, y: 23.97 },
        "207": { x: 52.27, y: 10.01 },
        "208": { x: 52.00, y: 23.97 },
        "209": { x: 57.27, y: 9.88 },
        "210": { x: 57.18, y: 24.10 },
        "211": { x: 62.36, y: 9.88 },
        "212": { x: 62.00, y: 24.10 },
        "213": { x: 67.00, y: 9.61 },
        "214": { x: 67.27, y: 24.50 },
        "215": { x: 72.36, y: 9.74 },
        "216": { x: 72.09, y: 24.24 },
        "217": { x: 77.73, y: 9.74 },
        "218": { x: 77.45, y: 24.63 },
        "219": { x: 83.73, y: 9.88 },
        "220": { x: 83.27, y: 24.37 },
        "221": { x: 89.27, y: 9.74 },
        "222": { x: 89.36, y: 24.50 }
      }

      function ensureMapDots(rows) {
        elMapLayer.innerHTML = ""

        for (const r of rows) {
          const code = String(r.unit_code || "")
          const pos = UNIT_POS[code]
          if (!pos || typeof pos.x !== "number" || typeof pos.y !== "number") continue

          const dot = document.createElement("div")
          dot.className = "unitDot " + unitColorClass(r)
          dot.style.left = pos.x + "%"
          dot.style.top = pos.y + "%"
          dot.title = "Enhet " + code

          dot.addEventListener("click", () => {
            const st = statusText(r)
            alert("Enhet " + code + "\n" + st)
          })

          elMapLayer.appendChild(dot)
        }
      }

      let pickEnabled = false
      let lastRows = []

      function togglePick() {
        pickEnabled = !pickEnabled
        elPickToggleBtn.textContent = pickEnabled ? "Deaktiver plassering" : "Aktiver plassering"
      }

      function appendPickLine(code, x, y) {
        const line = `"${code}": { x: ${x.toFixed(2)}, y: ${y.toFixed(2)} },`
        elPickOutput.value = (elPickOutput.value ? elPickOutput.value + "\n" : "") + line
      }

      function setPos(code, x, y) {
        UNIT_POS[code] = { x, y }
        ensureMapDots(lastRows)
      }

      elPickToggleBtn.addEventListener("click", togglePick)

      elMapWrap.addEventListener("click", (e) => {
        if (!pickEnabled) return

        const code = String((elPickUnitCode.value || "").trim())
        if (!code) {
          alert("Skriv enhetskode først, f.eks 101")
          return
        }

        const r = elMapWrap.getBoundingClientRect()
        const x = ((e.clientX - r.left) / r.width) * 100
        const y = ((e.clientY - r.top) / r.height) * 100

        appendPickLine(code, x, y)
        setPos(code, x, y)
      })

      let identityReadyResolve
      const identityReady = new Promise((res) => { identityReadyResolve = res })

      async function authHeaders(extra = {}) {
        const ni = window.netlifyIdentity
        const user = ni && ni.currentUser ? ni.currentUser() : null
        if (!user || !user.jwt) return extra
        const token = await user.jwt()
        if (!token) return extra
        return { ...extra, Authorization: "Bearer " + token }
      }

      async function loadUnits() {
        setMsg("Henter data")
        clearTable()

        try {
          await identityReady
          const headers = await authHeaders()
          const res = await fetch("/.netlify/functions/units", { headers })

          if (res.status === 401 || res.status === 403) {
            window.location.href = "/login/"
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Klarte ikke å hente data. Status " + res.status))
            return
          }

          const rows = await res.json()
          lastRows = Array.isArray(rows) ? rows : []

          setMsg("")
          fillUnitSelect(lastRows)
          ensureMapDots(lastRows)
          for (const r of lastRows) addRow(r)
        } catch (e) {
          setMsg("Klarte ikke å hente data")
        }
      }

      async function createBooking(e) {
        e.preventDefault()
        setMsg("")

        const unitId = document.getElementById("unitId").value
        const tenantName = document.getElementById("tenantName").value
        const company = document.getElementById("company").value
        const checkinDate = document.getElementById("checkinDate").value
        const checkoutDate = document.getElementById("checkoutDate").value

        if (!unitId || !checkinDate || !checkoutDate) {
          setMsg("Fyll inn enhet og datoer")
          return
        }

        const len = daysBetween(checkinDate, checkoutDate)
        if (len < 7) {
          setMsg("Minimum leieperiode er 7 netter")
          return
        }

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/create-booking", {
            method: "POST",
            headers,
            body: JSON.stringify({
              unit_id: Number(unitId),
              tenant_name: tenantName,
              company: company,
              checkin_date: checkinDate,
              checkout_date: checkoutDate
            })
          })

          if (res.status === 401 || res.status === 403) {
            const t = await res.text()
            setMsg(t || "Ingen tilgang")
            return
          }

          if (res.status === 409) {
            setMsg("Konflikt. Enheten er allerede booket i perioden")
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || "Feil ved oppretting")
            return
          }

          setMsg("Booking opprettet")
          document.getElementById("tenantName").value = ""
          document.getElementById("company").value = ""
          document.getElementById("checkinDate").value = ""
          document.getElementById("checkoutDate").value = ""
          await loadUnits()
        } catch (e) {
          setMsg("Feil ved oppretting")
        }
      }

      function logout() {
        const ni = window.netlifyIdentity
        if (!ni) return
        ni.logout()
        window.location.href = "/login/"
      }

      function initIdentity() {
        const ni = window.netlifyIdentity
        if (!ni) return

        ni.on("init", (user) => {
          if (!user) {
            window.location.href = "/login/"
            return
          }
          elWho.textContent = user.email || ""
          identityReadyResolve(user)
        })

        ni.on("logout", () => {
          window.location.href = "/login/"
        })

        ni.init()
      }

      document.getElementById("refreshBtn").addEventListener("click", loadUnits)
      document.getElementById("logoutBtn").addEventListener("click", logout)
      document.getElementById("form").addEventListener("submit", createBooking)

      initIdentity()
      identityReady.then(() => loadUnits())
    </script>
  </body>
</html>
