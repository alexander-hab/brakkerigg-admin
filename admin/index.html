<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brakkerigg admin</title>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <style>
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#0f172a;
        --muted:#64748b;
        --line:#e5e7eb;
        --shadow: 0 10px 25px rgba(15,23,42,0.06);
        --shadow2: 0 4px 12px rgba(15,23,42,0.06);
        --r: 14px;

        --green: rgba(34,197,94,0.30);
        --red: rgba(239,68,68,0.30);
        --yellow: rgba(234,179,8,0.30);

        --blue: rgba(59,130,246,0.30);
        --blueBorder: rgba(29,78,216,0.35);
      }

      *{ box-sizing:border-box; }

      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .wrap{
        max-width: 1200px;
        margin: 0 auto;
        padding: 22px;
      }

      .topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:14px;
        margin-bottom: 18px;
      }

      .brand{
        display:flex;
        align-items:center;
        gap:12px;
        min-width: 240px;
      }

      .logo{
        height: 34px;
        width:auto;
        display:block;
        object-fit:contain;
      }

      .title{
        display:flex;
        flex-direction:column;
        gap:2px;
      }

      .title h1{
        font-size: 16px;
        margin:0;
        font-weight: 800;
        letter-spacing: 0.2px;
      }

      .title div{
        font-size: 12px;
        color: var(--muted);
      }

      .actions{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }

      .who{
        font-size: 12px;
        color: var(--muted);
        padding: 8px 10px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: #fff;
      }

      .badge{
        font-size: 12px;
        color: #0f172a;
        padding: 8px 10px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: #fff;
        display:none;
      }

      .adminOnly{ display: none; }
      body.is-admin .adminOnly{ display: table-cell; }
      .adminOnlyBlock{ display: none; }
      body.is-admin .adminOnlyBlock{ display: block; }

      .btn{
        appearance:none;
        border: 1px solid var(--line);
        background: #fff;
        color: var(--text);
        border-radius: 10px;
        padding: 10px 12px;
        font-weight: 700;
        cursor:pointer;
        box-shadow: var(--shadow2);
      }

      .pageFooter{
        display:flex;
        justify-content:center;
        padding: 6px 22px 18px;
      }

      .footerCredit{
        font-size: 10px;
        color: var(--muted);
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 4px 10px;
        box-shadow: var(--shadow2);
      }

      .btn:hover{ filter: brightness(0.98); }
      .btn:active{ transform: translateY(1px); }

      .btnPrimary{
        background: #0f172a;
        color: #fff;
        border-color:#0f172a;
      }

      .btnDanger{
        background: #fff;
        border-color: rgba(239,68,68,0.35);
        color: #b91c1c;
      }

      .btnGhost{
        background:#fff;
        border-color: var(--line);
        box-shadow:none;
      }

      .btnSmall{
        padding: 6px 10px;
        border-radius: 10px;
        font-weight: 800;
        box-shadow: none;
      }

      .msg{
        margin: 0 0 14px 0;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
        color: var(--text);
        box-shadow: var(--shadow2);
        display:none;
      }

      .grid{
        display:grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }

      .card{
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--r);
        box-shadow: var(--shadow);
        padding: 14px;
      }

      .cardHead{
        display:flex;
        align-items:baseline;
        justify-content:space-between;
        gap: 12px;
        margin-bottom: 10px;
      }

      .cardHead h2{
        font-size: 14px;
        margin: 0;
        font-weight: 900;
        letter-spacing: 0.2px;
      }

      .cardHead .hint{
        font-size: 12px;
        color: var(--muted);
      }

      .muted{
        color: var(--muted);
        font-size: 12px;
        margin: 0;
      }

      .contractNotice{
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
      }

      .contractActions{
        margin-top: 8px;
        display:flex;
        flex-wrap:wrap;
        gap: 8px;
      }

      .warnText{
        margin-top: 8px;
        color: #b91c1c;
        font-size: 12px;
        display: none;
      }

      .mapWrap{ position: relative; width: 100%; max-width: 1100px; }
      .mapImg{
        width: 100%;
        height: auto;
        display:block;
        border: 1px solid var(--line);
        border-radius: 12px;
      }
      .mapLayer{ position:absolute; inset:0; }

      .unitBox{
        position:absolute;
        border-radius: 2px;
        cursor:pointer;
        pointer-events:auto;
        border: 1px solid rgba(2,6,23,0.12);
      }

      .unitGreen{ background: var(--green); }
      .unitRed{ background: var(--red); }
      .unitYellow{ background: var(--yellow); }

      .washBox{
        position:absolute;
        border-radius: 2px;
        pointer-events:none;
        border: 1px solid rgba(2,6,23,0.10);
        background: transparent;
        display:flex;
        align-items:flex-end;
        justify-content:flex-start;
        padding: 2px 3px;
        overflow:hidden;
      }

      .washBlue{
        background: var(--blue);
        border-color: var(--blueBorder);
      }

      .washTag{
        font-size: 10px;
        font-weight: 800;
        color: #0b2a6b;
        background: rgba(255,255,255,0.75);
        border: 1px solid rgba(29,78,216,0.20);
        border-radius: 6px;
        padding: 1px 5px;
        line-height: 1.2;
        white-space: nowrap;
      }

      .tableWrap{
        overflow:auto;
        border: 1px solid var(--line);
        border-radius: 12px;
      }

      table{
        width: 100%;
        border-collapse: collapse;
        min-width: 980px;
        background:#fff;
      }

      thead th{
        position: sticky;
        top: 0;
        background: #fbfbfd;
        z-index: 1;
        font-size: 12px;
        color: #334155;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      th, td{
        text-align:left;
        border-top: 1px solid var(--line);
        padding: 10px 10px;
        vertical-align: top;
        font-size: 13px;
      }

      tbody tr:hover{
        background: #fafafa;
      }

      .pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background:#fff;
        font-size: 12px;
        color: #0f172a;
        white-space: nowrap;
      }

      .dot{
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #94a3b8;
      }

      .pillGreen .dot{ background: #22c55e; }
      .pillRed .dot{ background: #ef4444; }
      .pillYellow .dot{ background: #eab308; }

      .legend{
        display:flex;
        gap: 14px;
        flex-wrap: wrap;
        margin: 0 0 12px 0;
        padding: 0;
        list-style: none;
        font-size: 12px;
        color: var(--muted);
      }

      .legend li{
        display:flex;
        align-items:center;
        gap: 6px;
      }

      .legendSwatch{
        width: 12px;
        height: 12px;
        border-radius: 3px;
        border: 1px solid rgba(2,6,23,0.15);
      }

      .legendGreen{ background: var(--green); }
      .legendYellow{ background: var(--yellow); }
      .legendRed{ background: var(--red); }

      label{
        display:block;
        font-size: 12px;
        color: #334155;
        margin-bottom: 6px;
        font-weight: 700;
      }

      input, select, textarea{
        width:100%;
        padding: 10px 10px;
        border: 1px solid var(--line);
        border-radius: 10px;
        font-size: 14px;
        background: #fff;
        outline: none;
      }

      textarea{ min-height: 40px; resize: vertical; }

      input:focus, select:focus, textarea:focus{
        border-color: rgba(15,23,42,0.35);
        box-shadow: 0 0 0 4px rgba(15,23,42,0.08);
      }

      .formGrid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .priceOutput{
        padding: 10px 10px;
        border: 1px dashed var(--line);
        border-radius: 10px;
        background: #f8fafc;
        font-size: 14px;
        color: #0f172a;
      }

      .formActions{
        margin-top: 12px;
        display:flex;
        gap:10px;
        align-items:center;
        justify-content:flex-start;
        flex-wrap:wrap;
      }

      .reportBox{
        margin-top: 14px;
        border: 1px dashed var(--line);
        border-radius: 12px;
        padding: 12px;
        background: #fbfbfd;
      }

      .reportBox h3{
        margin: 0 0 6px 0;
        font-size: 13px;
        font-weight: 900;
      }

      .reportBox .hint{
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 10px;
      }

      .upLine{
        display:flex;
        gap: 8px;
        align-items:center;
        justify-content:space-between;
        margin-bottom: 6px;
      }

      .upText{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 360px;
        color:#0f172a;
      }

      .priceCell{
        text-align: right;
        white-space: nowrap;
        color:#0f172a;
      }

      .kpi{
        margin: 10px 0 12px 0;
        padding: 10px 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fbfbfd;
        color: #0f172a;
        font-weight: 800;
        font-size: 13px;
      }

      .split{
        display:grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .reqTable{
        min-width: 980px;
      }

      .reqSuccess{
        display:none;
        margin: 8px 0 0 0;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(34,197,94,0.4);
        background: rgba(34,197,94,0.15);
        color: #166534;
        font-size: 12px;
        font-weight: 800;
        width: fit-content;
      }

      @media (max-width: 860px){
        .formGrid{ grid-template-columns: 1fr; }
        .actions{ justify-content:flex-start; }
        .topbar{ flex-direction:column; align-items:flex-start; }
        table{ min-width: 900px; }
      }

      @media print{
        body{ background:#fff; }
        .topbar, .msg, #refreshBtn, #logoutBtn, #printWashBtn, .noPrint{ display:none !important; }
        .card{ box-shadow:none; border: 1px solid #ddd; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <img class="logo" src="/admin/Hab.Logo.png" alt="HAB" />
          <div class="title">
            <h1>Brakkerigg</h1>
            <div>Oversikt, vask og booking</div>
          </div>
        </div>

        <div class="actions">
          <span class="badge" id="reqBadge"></span>
          <span class="who" id="who"></span>
          <button class="btn" id="refreshBtn" type="button">Oppdater</button>
          <button class="btn btnDanger" id="logoutBtn" type="button">Logg ut</button>
        </div>
      </div>

      <div class="msg" id="msg"></div>

      <div class="grid">
        <div class="card">
          <div class="cardHead">
            <h2>Kart</h2>
            <div class="hint">Klikk på et rom</div>
          </div>
          <ul class="legend">
            <li><span class="legendSwatch legendGreen"></span> Ledig</li>
            <li><span class="legendSwatch legendYellow"></span> Ledig, booket</li>
            <li><span class="legendSwatch legendRed"></span> Utleid</li>
          </ul>
          <div class="mapWrap" id="mapWrap">
            <img class="mapImg" src="/admin/kart.png" alt="Kart over enheter" />
            <div class="mapLayer" id="mapLayer"></div>
          </div>
        </div>

        <div class="card">
          <div class="cardHead">
            <h2>Oversikt</h2>
            <div class="hint">Endringer krever admin</div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Enhet</th>
                  <th>Status</th>
                  <th class="adminOnly">Booking nr</th>
                  <th>Leietaker nå</th>
                  <th>Firma</th>
                  <th>Innflytting</th>
                  <th>Utflytting</th>
                  <th>Dager igjen</th>
                  <th>Lengde nå</th>
                  <th class="priceCell">Pris</th>
                  <th>Kommende bookinger</th>
                  <th>Handling</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" id="bookingCard">
          <div class="cardHead">
            <h2>Ny booking</h2>
            <div class="hint">Kun admin</div>
          </div>

          <p class="muted">Pris: 1-3 uker koster 2500 kr per uke. 4 uker eller mer koster 2100 kr per uke (8400kr per måned).</p>
          <p class="muted">Bookinger må være fra mandag til mandag i hele uker. Utflytting er datoen de forlater enheten.</p>

          <form id="form">
            <div class="formGrid">
              <div>
                <label>Innflytting</label>
                <input id="checkinDate" type="date" />
              </div>
              <div>
                <label>Utflytting</label>
                <input id="checkoutDate" type="date" />
              </div>
              <div>
                <label>Enhet</label>
                <select id="unitId" disabled>
                  <option value="">Velg datoer først</option>
                </select>
              </div>
              <div>
                <label>Firma</label>
                <input id="company" />
              </div>
              <div>
                <label>Leietaker</label>
                <input id="tenantName" />
              </div>
              <div>
                <label>E-post</label>
                <input id="tenantEmail" type="email" />
              </div>
              <div>
                <label>Telefon</label>
                <input id="tenantPhone" type="tel" />
              </div>
              <div>
                <label>Pris</label>
                <div class="priceOutput" id="bookingPrice">—</div>
              </div>
            </div>

            <div class="formActions">
              <button class="btn btnPrimary" type="submit">Opprett booking</button>
            </div>
          </form>

          <div class="reportBox adminOnlyBlock">
            <h3>Bookingrapport</h3>
            <div class="hint">Velg periode og generer PDF med bookinger i perioden.</div>
            <div class="formGrid">
              <div>
                <label>Fra dato</label>
                <input id="reportStart" type="date" />
              </div>
              <div>
                <label>Til dato</label>
                <input id="reportEnd" type="date" />
              </div>
            </div>
            <div class="formActions">
              <button class="btn btnGhost" type="button" id="reportBtn">Generer PDF</button>
            </div>
          </div>
        </div>

        <div class="card" id="washCard">
          <div class="cardHead">
            <h2 id="washTitle">Vasking</h2>
            <div class="hint">Plan for uka</div>
          </div>

          <div class="kpi" id="washKpi"></div>

          <div class="cardHead" style="margin-top:2px">
            <h2 style="font-size:13px; font-weight:900; margin:0">Vaskekart</h2>
            <div class="hint">Blå betyr vask denne uka</div>
          </div>

          <div class="mapWrap" id="washMapWrap">
            <img class="mapImg" src="/admin/kart.png" alt="Vaskekart" />
            <div class="mapLayer" id="washMapLayer"></div>
          </div>

          <div class="formActions" style="margin-top:10px">
            <button class="btn btnGhost" type="button" id="printWashBtn">Print ut vaske plan</button>
          </div>

          <div class="cardHead" style="margin-top:12px">
            <h2 style="font-size:13px; font-weight:900; margin:0">Enheter som skal vaskes</h2>
            <div class="hint">Liste</div>
          </div>

          <div class="tableWrap">
            <table style="min-width: 720px">
              <thead>
                <tr>
                  <th>Enhet</th>
                  <th>Årsak</th>
                  <th>Dato</th>
                </tr>
              </thead>
              <tbody id="washTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" id="requestCard">
          <div class="cardHead">
            <h2>Forespør booking</h2>
            <div class="hint">Sendes til admin</div>
          </div>

          <p class="muted">Pris: 1-3 uker koster 2500 kr per uke. 4 uker eller mer koster 2100 kr per uke (8400kr per måned).</p>
          <p class="muted">Du kan legge inn flere linjer. Admin godkjenner eller avslår per linje.</p>
          <p class="muted"><strong>Viktig:</strong> Inn- og utflytting må være mandag–mandag (hele uker).</p>
          <p class="muted">Hvis romnummer ikke vises i ønsket periode, er rommet allerede forespurt eller booket selv om det ser ledig ut i oversikten.</p>
          <div class="reqSuccess" id="reqSuccess">Forespørsel sendt</div>
          <div class="contractNotice">Fyll ut og send inn signert kontrakt til steffan@hab.no.</div>
          <div class="contractActions">
            <a class="btn btnGhost btnSmall" href="/admin/kontrakt-norsk.pdf" download>Kontrakt norsk</a>
            <a class="btn btnGhost btnSmall" href="/admin/kontrakt-engelsk.pdf" download>Kontrakt engelsk</a>
            <a class="btn btnGhost btnSmall" href="/admin/kontrakt-polsk.pdf" download>Kontrakt polsk</a>
          </div>

          <form id="reqForm">
            <div class="formGrid">
              <div>
                <label>E-post</label>
                <input id="reqEmail" type="email" />
              </div>
              <div>
                <label>Telefon</label>
                <input id="reqPhone" type="tel" />
              </div>
            </div>

            <div class="warnText" id="reqDateWarning">NB bookinger kan bare gjøres fra Mandag-Mandag.</div>
            <div style="margin-top:12px" class="tableWrap">
              <table class="reqTable">
                <thead>
                  <tr>
                    <th>Innflytting</th>
                    <th>Utflytting</th>
                    <th>Enhet</th>
                    <th>Firma</th>
                    <th>Leietaker</th>
                    <th>Kommentar</th>
                    <th class="priceCell">Pris</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="reqLinesTbody"></tbody>
              </table>
            </div>

            <div class="formActions">
              <button class="btn" type="button" id="addReqLineBtn">Legg til linje</button>
              <button class="btn btnPrimary" type="submit">Send forespørsel</button>
            </div>
          </form>
        </div>

        <div class="card" id="adminRequestsCard">
          <div class="cardHead">
            <h2>Forespurte bookinger</h2>
            <div class="hint">Kun admin</div>
          </div>

          <div class="tableWrap">
            <table class="reqTable">
              <thead>
                <tr>
                  <th>Forespørsel</th>
                  <th>Kontakt</th>
                  <th>Enhet</th>
                  <th>Periode</th>
                  <th>Firma</th>
                  <th>Leietaker</th>
                  <th>Kommentar</th>
                  <th>Status</th>
                  <th>Handling</th>
                </tr>
              </thead>
              <tbody id="adminReqTbody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

    <footer class="pageFooter">
      <div class="footerCredit">Utviklet av Alexander Buer</div>
    </footer>

    <script>
      const elMsg = document.getElementById("msg")
      const elTbody = document.getElementById("tbody")
      const elWho = document.getElementById("who")
      const elMapLayer = document.getElementById("mapLayer")

      const elBookingCard = document.getElementById("bookingCard")
      const elWashCard = document.getElementById("washCard")
      const elWashTitle = document.getElementById("washTitle")
      const elWashKpi = document.getElementById("washKpi")
      const elWashTbody = document.getElementById("washTbody")
      const elWashMapLayer = document.getElementById("washMapLayer")

      const elRequestCard = document.getElementById("requestCard")
      const elAdminRequestsCard = document.getElementById("adminRequestsCard")
      const elAdminReqTbody = document.getElementById("adminReqTbody")
      const elReqBadge = document.getElementById("reqBadge")
      const elReqSuccess = document.getElementById("reqSuccess")

      const elUnitSelect = document.getElementById("unitId")
      const elCheckin = document.getElementById("checkinDate")
      const elCheckout = document.getElementById("checkoutDate")
      const elBookingPrice = document.getElementById("bookingPrice")
      const elReportStart = document.getElementById("reportStart")
      const elReportEnd = document.getElementById("reportEnd")
      const elReportBtn = document.getElementById("reportBtn")

      const elReqEmail = document.getElementById("reqEmail")
      const elReqPhone = document.getElementById("reqPhone")
      const elReqLinesTbody = document.getElementById("reqLinesTbody")
      const elReqDateWarning = document.getElementById("reqDateWarning")

      let isAdmin = false
      let unitRows = []

      const CLEAN_WEEKDAY = 1
      const BASE_WASHDAY_ISO = "2026-01-26"
      const BASE_FLOOR = 1

      function setMsg(t) {
        if (!t) {
          elMsg.textContent = ""
          elMsg.style.display = "none"
          return
        }
        elMsg.textContent = t
        elMsg.style.display = "block"
      }

      function fmtDate(s) {
        if (!s) return ""
        if (typeof s !== "string") return String(s)
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/)
        if (!m) return s
        return m[3] + "-" + m[2] + "-" + m[1]
      }

      function fmtRange(a, b) {
        const aa = fmtDate(a)
        const bb = fmtDate(b)
        if (!aa && !bb) return ""
        if (!aa) return bb
        if (!bb) return aa
        return aa + " til " + bb
      }

      function parseIsoDate(s) {
        if (!s || typeof s !== "string") return null
        if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null
        return new Date(s + "T00:00:00")
      }

      function dateToIso(d) {
        const y = d.getFullYear()
        const m = String(d.getMonth() + 1).padStart(2, "0")
        const dd = String(d.getDate()).padStart(2, "0")
        return y + "-" + m + "-" + dd
      }

      function isoToday() {
        return dateToIso(new Date())
      }

      function addDaysIso(iso, days) {
        const d = parseIsoDate(iso)
        if (!d) return iso
        d.setDate(d.getDate() + days)
        return dateToIso(d)
      }

      function daysBetween(a, b) {
        if (!a || !b) return ""
        const da = parseIsoDate(a)
        const db = parseIsoDate(b)
        if (!da || !db) return ""
        const diff = Math.round((db - da) / (1000 * 60 * 60 * 24))
        return Number.isFinite(diff) ? diff : ""
      }

      function isMondayIso(iso) {
        const d = parseIsoDate(iso)
        return d ? d.getDay() === 1 : false
      }

      function isWholeWeeks(checkin, checkout) {
        const len = daysBetween(checkin, checkout)
        return Number.isFinite(len) && len >= 7 && len % 7 === 0
      }

      function bookingWeeks(checkin, checkout) {
        const len = daysBetween(checkin, checkout)
        if (!Number.isFinite(len) || len < 7 || len % 7 !== 0) return null
        return len / 7
      }

      function bookingPriceForWeeks(weeks) {
        if (!Number.isFinite(weeks) || weeks <= 0) return null
        const rate = weeks >= 4 ? 2100 : 2500
        return weeks * rate
      }

      function formatPriceKr(amount) {
        if (!Number.isFinite(amount)) return ""
        return amount.toLocaleString("nb-NO") + " kr"
      }

      function priceLabel(checkin, checkout) {
        if (!isMondayIso(checkin) || !isMondayIso(checkout)) return ""
        const weeks = bookingWeeks(checkin, checkout)
        if (!weeks) return ""
        return formatPriceKr(bookingPriceForWeeks(weeks))
      }

      function updateBookingPriceDisplay() {
        if (!elBookingPrice) return
        const price = priceLabel(elCheckin.value, elCheckout.value)
        elBookingPrice.textContent = price || "—"
      }


      function daysLeft(checkout) {
        if (!checkout) return ""
        return daysBetween(isoToday(), checkout)
      }

      function safeJsonParseArray(x) {
        if (Array.isArray(x)) return x
        if (typeof x !== "string") return []
        try {
          const p = JSON.parse(x)
          return Array.isArray(p) ? p : []
        } catch {
          return []
        }
      }

      function getUpcoming(row) {
        const up = safeJsonParseArray(row.upcoming_bookings)
        up.sort((a, b) => String(a.checkin_date || "").localeCompare(String(b.checkin_date || "")))
        return up
      }

      function overlaps(aStart, aEnd, bStart, bEnd) {
        const as = parseIsoDate(aStart)
        const ae = parseIsoDate(aEnd)
        const bs = parseIsoDate(bStart)
        const be = parseIsoDate(bEnd)
        if (!as || !ae || !bs || !be) return false
        return as < be && ae > bs
      }

      function unitBookings(row) {
        const list = []
        if (row.current_checkin_date && row.current_checkout_date) {
          list.push({ checkin_date: row.current_checkin_date, checkout_date: row.current_checkout_date })
        }
        const up = getUpcoming(row)
        for (const b of up) {
          if (b && b.checkin_date && b.checkout_date) list.push({ checkin_date: b.checkin_date, checkout_date: b.checkout_date })
        }
        return list
      }

      function unitIsFree(row, checkin, checkout) {
        if (!checkin || !checkout) return true
        const bookings = unitBookings(row)
        for (const b of bookings) {
          if (overlaps(b.checkin_date, b.checkout_date, checkin, checkout)) return false
        }
        return true
      }

      function availableUnits(checkin, checkout) {
        return unitRows.filter(r => unitIsFree(r, checkin, checkout))
      }

      function unitColorClass(row) {
        const today = isoToday()
        if (row.current_booking_id) return "unitRed"

        const up = getUpcoming(row)
        const nextStart = row.next_checkin_date || (up[0] ? up[0].checkin_date : null)

        if (nextStart) {
          if (today < nextStart) return "unitYellow"
          return "unitRed"
        }
        return "unitGreen"
      }

      function statusPill(row) {
        const pill = document.createElement("span")
        const cls = unitColorClass(row)
        const dot = document.createElement("span")
        dot.className = "dot"
        pill.appendChild(dot)

        let text = "Ledig"
        pill.className = "pill"
        if (cls === "unitRed") { pill.className += " pillRed"; text = "Utleid" }
        else if (cls === "unitYellow") { pill.className += " pillYellow"; text = "Ledig, booket" }
        else { pill.className += " pillGreen"; text = "Ledig" }

        pill.appendChild(document.createTextNode(text))
        return pill
      }

      function bookingWho(booking) {
        if (!booking) return ""
        if (isAdmin) return booking.company || booking.tenant_name || ""
        return booking.company || ""
      }

      function bookingIdLabel(bookingId) {
        if (!isAdmin || !bookingId) return ""
        return "Booking #" + bookingId
      }


      function clearTable() {
        elTbody.innerHTML = ""
      }

      function upcomingCell(row) {
        const td = document.createElement("td")
        const up = getUpcoming(row)
        if (up.length === 0) {
          td.textContent = ""
          return td
        }

        const wrap = document.createElement("div")
        for (const b of up) {
          const line = document.createElement("div")
          line.className = "upLine"

          const txt = document.createElement("div")
          txt.className = "upText"
          const who = bookingWho(b)
          const whoText = who ? (" " + who) : ""
          const idText = bookingIdLabel(b.id)
          const idSuffix = idText ? (" · " + idText) : ""
          const priceText = priceLabel(b.checkin_date || "", b.checkout_date || "")
          const priceSuffix = priceText ? (" · Pris: " + priceText) : ""
          txt.textContent = fmtRange(b.checkin_date || "", b.checkout_date || "") + whoText + idSuffix + priceSuffix

          line.appendChild(txt)

          if (isAdmin) {
            const del = document.createElement("button")
            del.type = "button"
            del.className = "btn btnSmall btnDanger"
            del.textContent = "Slett"
            del.addEventListener("click", () => deleteBooking(Number(b.id)))
            line.appendChild(del)
          }

          wrap.appendChild(line)
        }

        td.appendChild(wrap)
        return td
      }

      function addRow(row) {
        const tr = document.createElement("tr")

        const lengthNow = row.current_checkin_date && row.current_checkout_date
          ? daysBetween(row.current_checkin_date, row.current_checkout_date)
          : ""

        const tdUnit = document.createElement("td")
        tdUnit.textContent = row.unit_code || ""
        tr.appendChild(tdUnit)

        const tdStatus = document.createElement("td")
        tdStatus.appendChild(statusPill(row))
        tr.appendChild(tdStatus)

        const tdBooking = document.createElement("td")
        tdBooking.className = "adminOnly"
        tdBooking.textContent = row.current_booking_id ? String(row.current_booking_id) : ""
        tr.appendChild(tdBooking)


        const tdTenant = document.createElement("td")
        tdTenant.textContent = isAdmin ? (row.current_tenant_name || "") : ""
        tr.appendChild(tdTenant)

        const tdCompany = document.createElement("td")
        tdCompany.textContent = row.current_company || ""
        tr.appendChild(tdCompany)

        const tdIn = document.createElement("td")
        tdIn.textContent = fmtDate(row.current_checkin_date || "")
        tr.appendChild(tdIn)

        const tdOut = document.createElement("td")
        tdOut.textContent = fmtDate(row.current_checkout_date || "")
        tr.appendChild(tdOut)

        const tdLeft = document.createElement("td")
        tdLeft.textContent = row.current_checkout_date ? daysLeft(row.current_checkout_date) : ""
        tr.appendChild(tdLeft)

        const tdLen = document.createElement("td")
        tdLen.textContent = lengthNow
        tr.appendChild(tdLen)

        const tdPrice = document.createElement("td")
        tdPrice.className = "priceCell"
        tdPrice.textContent = priceLabel(row.current_checkin_date, row.current_checkout_date)
        tr.appendChild(tdPrice)

        tr.appendChild(upcomingCell(row))

        const tdActions = document.createElement("td")
        if (isAdmin && row.current_booking_id) {
          const btn = document.createElement("button")
          btn.type = "button"
          btn.className = "btn btnSmall btnDanger"
          btn.textContent = "Slett aktiv"
          btn.addEventListener("click", () => deleteBooking(Number(row.current_booking_id)))
          tdActions.appendChild(btn)
        } else {
          tdActions.textContent = ""
        }
        tr.appendChild(tdActions)

        elTbody.appendChild(tr)
      }

      const ROW_1ETG_TOP = [101,103,105,107,109,111,113,115,117,119,121]
      const ROW_1ETG_BOT = [102,104,106,108,110,112,114,116,118,120,122]
      const ROW_2ETG_TOP = [201,203,205,207,209,211,213,215,217,219,221]
      const ROW_2ETG_BOT = [202,204,206,208,210,212,214,216,218,220,222]

      const UNIT_POS = {
        "101": { x: 38.55, y: 56.15 }, "102": { x: 38.55, y: 70.77 },
        "103": { x: 43.09, y: 55.75 }, "104": { x: 43.27, y: 70.64 },
        "105": { x: 47.73, y: 56.01 }, "106": { x: 47.64, y: 70.77 },
        "107": { x: 52.91, y: 56.15 }, "108": { x: 52.82, y: 70.77 },
        "109": { x: 58.00, y: 56.01 }, "110": { x: 57.73, y: 70.64 },
        "111": { x: 63.18, y: 56.15 }, "112": { x: 63.18, y: 70.77 },
        "113": { x: 67.82, y: 56.28 }, "114": { x: 68.00, y: 71.04 },
        "115": { x: 73.09, y: 56.28 }, "116": { x: 73.00, y: 71.04 },
        "117": { x: 78.55, y: 56.15 }, "118": { x: 78.36, y: 71.04 },
        "119": { x: 84.18, y: 56.01 }, "120": { x: 84.18, y: 70.77 },
        "121": { x: 90.27, y: 56.55 }, "122": { x: 90.18, y: 70.90 },

        "201": { x: 37.82, y: 9.61 },  "202": { x: 37.64, y: 24.10 },
        "203": { x: 42.27, y: 9.74 },  "204": { x: 42.64, y: 24.10 },
        "205": { x: 47.00, y: 9.88 },  "206": { x: 47.00, y: 23.97 },
        "207": { x: 52.27, y: 10.01 }, "208": { x: 52.00, y: 23.97 },
        "209": { x: 57.27, y: 9.88 },  "210": { x: 57.18, y: 24.10 },
        "211": { x: 62.36, y: 9.88 },  "212": { x: 62.00, y: 24.10 },
        "213": { x: 67.00, y: 9.61 },  "214": { x: 67.27, y: 24.50 },
        "215": { x: 72.36, y: 9.74 },  "216": { x: 72.09, y: 24.24 },
        "217": { x: 77.73, y: 9.74 },  "218": { x: 77.45, y: 24.63 },
        "219": { x: 83.73, y: 9.88 },  "220": { x: 83.27, y: 24.37 },
        "221": { x: 89.27, y: 9.74 },  "222": { x: 89.36, y: 24.50 }
      }

      function avg(nums) {
        if (!nums.length) return null
        let s = 0
        for (const n of nums) s += n
        return s / nums.length
      }

      function xyFor(code) {
        const p = UNIT_POS[String(code)]
        if (!p || typeof p.x !== "number" || typeof p.y !== "number") return null
        return p
      }

      function buildRectsFromCenters(rowTop, rowBot) {
        const cols = Math.max(rowTop.length, rowBot.length)
        if (!cols) return {}

        const xCenters = []
        for (let i = 0; i < cols; i++) {
          const a = xyFor(rowTop[i])
          const b = xyFor(rowBot[i])
          const xs = []
          if (a) xs.push(a.x)
          if (b) xs.push(b.x)
          const x = avg(xs)
          if (x == null) return {}
          xCenters.push(x)
        }

        const yTop = avg(rowTop.map(c => xyFor(c)).filter(Boolean).map(p => p.y))
        const yBot = avg(rowBot.map(c => xyFor(c)).filter(Boolean).map(p => p.y))
        if (yTop == null || yBot == null) return {}

        const yMid = (yTop + yBot) / 2
        const yTopOuter = 2 * yTop - yMid
        const yBotOuter = 2 * yBot - yMid

        const xWalls = []
        xWalls.push(xCenters[0] - (xCenters[1] - xCenters[0]) / 2)
        for (let i = 0; i < cols - 1; i++) {
          xWalls.push((xCenters[i] + xCenters[i + 1]) / 2)
        }
        xWalls.push(xCenters[cols - 1] + (xCenters[cols - 1] - xCenters[cols - 2]) / 2)

        const rects = {}
        for (let i = 0; i < cols; i++) {
          const left = xWalls[i]
          const right = xWalls[i + 1]
          const w = right - left
          const ct = rowTop[i]
          const cb = rowBot[i]
          if (ct != null) rects[String(ct)] = { left, top: yTopOuter, width: w, height: (yMid - yTopOuter) }
          if (cb != null) rects[String(cb)] = { left, top: yMid, width: w, height: (yBotOuter - yMid) }
        }
        return rects
      }

      function clampRect(r) {
        const left = Math.max(0, Math.min(100, r.left))
        const top = Math.max(0, Math.min(100, r.top))
        const width = Math.max(0, Math.min(100 - left, r.width))
        const height = Math.max(0, Math.min(100 - top, r.height))
        return { left, top, width, height }
      }

      const UNIT_RECT = Object.assign(
        {},
        buildRectsFromCenters(ROW_1ETG_TOP, ROW_1ETG_BOT),
        buildRectsFromCenters(ROW_2ETG_TOP, ROW_2ETG_BOT)
      )

      function renderMap(rows) {
        elMapLayer.innerHTML = ""

        for (const r of rows) {
          const code = String(r.unit_code || "")
          const raw = UNIT_RECT[code]
          if (!raw) continue
          const rect = clampRect(raw)

          const box = document.createElement("div")
          box.className = "unitBox " + unitColorClass(r)

          box.style.left = rect.left.toFixed(4) + "%"
          box.style.top = rect.top.toFixed(4) + "%"
          box.style.width = rect.width.toFixed(4) + "%"
          box.style.height = rect.height.toFixed(4) + "%"

          box.title = "Enhet " + code

          box.addEventListener("click", () => {
            const lines = []
            lines.push("Enhet " + code)
            lines.push(statusPill(r).textContent || "")
            if (isAdmin && r.current_booking_id) lines.push("Booking: " + r.current_booking_id)
            if (r.current_company) lines.push("Firma: " + r.current_company)
            if (isAdmin && r.current_tenant_name) lines.push("Leietaker: " + r.current_tenant_name)
            if (r.current_checkin_date) lines.push("Inn: " + fmtDate(r.current_checkin_date))
            if (r.current_checkout_date) lines.push("Ut: " + fmtDate(r.current_checkout_date))

            const up = getUpcoming(r)
            if (up.length > 0) {
              lines.push("Kommende:")
              for (let i = 0; i < Math.min(6, up.length); i++) {
                const b = up[i]
                const who = bookingWho(b)
                const whoText = who ? (" " + who) : ""
                const idText = bookingIdLabel(b.id)
                const idSuffix = idText ? (" · " + idText) : ""
                lines.push(fmtRange(b.checkin_date || "", b.checkout_date || "") + whoText + idSuffix)
              }
            }

            alert(lines.join("\n"))
          })

          elMapLayer.appendChild(box)
        }
      }

      function nextOrSameWeekday(fromDate, weekday) {
        const d = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate())
        const cur = d.getDay()
        const delta = (weekday - cur + 7) % 7
        d.setDate(d.getDate() + delta)
        return d
      }

      function weeksBetweenIso(aIso, bIso) {
        const a = parseIsoDate(aIso)
        const b = parseIsoDate(bIso)
        if (!a || !b) return 0
        const diff = Math.round((b - a) / (1000 * 60 * 60 * 24))
        return Math.floor(diff / 7)
      }

      function floorThisWeek(washDayIso) {
        const w = weeksBetweenIso(BASE_WASHDAY_ISO, washDayIso)
        const parity = ((w % 2) + 2) % 2
        return parity === 0 ? BASE_FLOOR : (BASE_FLOOR === 1 ? 2 : 1)
      }

      function plannedUnitsForFloor(floor) {
        const out = []
        if (floor === 1) {
          for (let i = 101; i <= 122; i++) out.push(String(i))
        } else {
          for (let i = 201; i <= 222; i++) out.push(String(i))
        }
        return out
      }

      function collectMoveOutUnits(rows, periodStartIso, periodEndIso) {
        const s = new Set()
        for (const r of rows) {
          const code = String(r.unit_code || "")
          const dates = []
          if (r.current_checkout_date) dates.push(r.current_checkout_date)
          const up = getUpcoming(r)
          for (const b of up) {
            if (b && b.checkout_date) dates.push(b.checkout_date)
          }
          for (const d of dates) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(String(d))) continue
            if (String(d) > periodStartIso && String(d) <= periodEndIso) s.add(code)
          }
        }
        return s
      }

      function renderWash(rows) {
        const today = new Date()
        const washDay = nextOrSameWeekday(today, CLEAN_WEEKDAY)
        const washDayIso = dateToIso(washDay)
        const periodStartIso = addDaysIso(washDayIso, -7)

        const floor = floorThisWeek(washDayIso)
        const planned = new Set(plannedUnitsForFloor(floor))
        const moveouts = collectMoveOutUnits(rows, periodStartIso, washDayIso)

        const clean = new Set()
        for (const u of planned) clean.add(u)
        for (const u of moveouts) clean.add(u)

        let extra = 0
        for (const u of moveouts) if (!planned.has(u)) extra++

        elWashTitle.textContent = "Vasking foregår " + fmtDate(washDayIso)
        elWashKpi.textContent =
          "Periode for utflytt-vask: " + fmtDate(periodStartIso) +
          " til " + fmtDate(washDayIso) +
          ". Etasje denne uka: " + floor +
          ". Ekstra utflytt-vask: " + extra + "."

        const list = Array.from(clean).sort((a,b) => a.localeCompare(b, "nb"))

        elWashTbody.innerHTML = ""
        for (const code of list) {
          const tr = document.createElement("tr")

          const tdA = document.createElement("td")
          tdA.textContent = code
          tr.appendChild(tdA)

          const tdB = document.createElement("td")
          const isMoveOut = moveouts.has(code) && !planned.has(code)
          tdB.textContent = planned.has(code) ? (isMoveOut ? "Etasje, utflytting" : "Etasje") : "Utflytting"
          tr.appendChild(tdB)

          const tdC = document.createElement("td")
          tdC.textContent = moveouts.has(code) ? fmtDate(washDayIso) : fmtDate(washDayIso)
          tr.appendChild(tdC)

          elWashTbody.appendChild(tr)
        }

        elWashMapLayer.innerHTML = ""
        for (const r of rows) {
          const code = String(r.unit_code || "")
          const raw = UNIT_RECT[code]
          if (!raw) continue
          const rect = clampRect(raw)

          const box = document.createElement("div")
          box.className = "washBox" + (clean.has(code) ? " washBlue" : "")

          box.style.left = rect.left.toFixed(4) + "%"
          box.style.top = rect.top.toFixed(4) + "%"
          box.style.width = rect.width.toFixed(4) + "%"
          box.style.height = rect.height.toFixed(4) + "%"

          if (clean.has(code) && moveouts.has(code) && !planned.has(code)) {
            const tag = document.createElement("div")
            tag.className = "washTag"
            tag.textContent = "utflytting"
            box.appendChild(tag)
          }

          elWashMapLayer.appendChild(box)
        }

        return { washDayIso, periodStartIso, floor, list, moveouts, planned }
      }

      function canUsePdfLibs() {
        return typeof html2canvas === "function" && window.jspdf && window.jspdf.jsPDF
      }

      async function printWashPlan() {
        try {
          if (!canUsePdfLibs()) {
            setMsg("Fant ikke PDF-bibliotek. Oppdater siden.")
            return
          }

          const mapEl = document.getElementById("washMapWrap")
          const kpi = elWashKpi.textContent || ""
          const rows = []
          for (const tr of elWashTbody.querySelectorAll("tr")) {
            const tds = tr.querySelectorAll("td")
            rows.push({
              unit: (tds[0] && tds[0].textContent) ? tds[0].textContent.trim() : "",
              reason: (tds[1] && tds[1].textContent) ? tds[1].textContent.trim() : "",
              date: (tds[2] && tds[2].textContent) ? tds[2].textContent.trim() : ""
            })
          }

          const canvas = await html2canvas(mapEl, { scale: 2, useCORS: true, backgroundColor: "#ffffff" })
          const imgData = canvas.toDataURL("image/png")

          const { jsPDF } = window.jspdf
          const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" })

          const pageW = doc.internal.pageSize.getWidth()
          const pageH = doc.internal.pageSize.getHeight()
          const margin = 40

          let y = margin
          doc.setFont("helvetica", "bold")
          doc.setFontSize(14)
          doc.text("Vaskeplan", margin, y)
          y += 18

          doc.setFont("helvetica", "normal")
          doc.setFontSize(10)
          const kpiLines = doc.splitTextToSize(kpi, pageW - margin * 2)
          doc.text(kpiLines, margin, y)
          y += (kpiLines.length * 12) + 12

          const imgMaxW = pageW - margin * 2
          const imgMaxH = 260
          const imgW = imgMaxW
          const imgH = Math.min(imgMaxH, (canvas.height / canvas.width) * imgW)
          doc.addImage(imgData, "PNG", margin, y, imgW, imgH)
          y += imgH + 18

          doc.setFont("helvetica", "bold")
          doc.setFontSize(11)
          doc.text("Enheter som skal vaskes", margin, y)
          y += 14

          doc.setFont("helvetica", "normal")
          doc.setFontSize(10)

          const lineH = 12
          for (const r of rows) {
            const line = (r.unit ? r.unit : "") + "  " + (r.reason ? r.reason : "")
            if (y > pageH - margin) {
              doc.addPage()
              y = margin
            }
            doc.text(line, margin, y)
            y += lineH
          }

          doc.save("vaskeplan.pdf")
        } catch {
          setMsg("Klarte ikke å lage PDF")
        }
      }

      function collectBookingsForReport(startIso, endIso) {
        const list = []
        for (const row of unitRows) {
          const unitCode = row.unit_code || ""
          if (row.current_checkin_date && row.current_checkout_date) {
            list.push({
              unit_code: unitCode,
              booking_id: row.current_booking_id || "",
              company: row.current_company || "",
              tenant_name: row.current_tenant_name || "",
              tenant_email: row.current_tenant_email || "",
              tenant_phone: row.current_tenant_phone || "",
              checkin_date: row.current_checkin_date,
              checkout_date: row.current_checkout_date
            })
          }

          const up = getUpcoming(row)
          for (const b of up) {
            if (!b || !b.checkin_date || !b.checkout_date) continue
            list.push({
              unit_code: unitCode,
              booking_id: b.id || "",
              company: b.company || "",
              tenant_name: b.tenant_name || "",
              tenant_email: b.tenant_email || "",
              tenant_phone: b.tenant_phone || "",
              checkin_date: b.checkin_date,
              checkout_date: b.checkout_date
            })
          }
        }

        return list.filter((b) => overlaps(b.checkin_date, b.checkout_date, startIso, endIso))
      }

      async function fetchBookingsForReport(startIso, endIso) {
        await identityReady
        const headers = await authHeaders({ "Content-Type": "application/json" })
        const res = await fetch("/.netlify/functions/report-bookings", {
          method: "POST",
          headers,
          body: JSON.stringify({ start: startIso, end: endIso })
        })
        if (!res.ok) {
          const t = await res.text()
          throw new Error(t || "Klarte ikke å hente rapportdata")
        }
        const payload = await res.json()
        return Array.isArray(payload?.bookings) ? payload.bookings : []
      }

      function bookingReportLine(booking) {
        const parts = []
        if (booking.unit_code) parts.push("Enhet " + booking.unit_code)
        parts.push("Periode " + fmtRange(booking.checkin_date, booking.checkout_date))

        const detailParts = []
        if (booking.company) detailParts.push(booking.company)
        if (booking.tenant_name) detailParts.push(booking.tenant_name)
        if (booking.tenant_email) detailParts.push(booking.tenant_email)
        if (booking.tenant_phone) detailParts.push(booking.tenant_phone)
        if (detailParts.length) parts.push(detailParts.join(" · "))
        if (booking.booking_id) parts.push("Booking #" + booking.booking_id)
        return parts.join(" · ")
      }

      async function generateBookingReport() {
        try {
          if (!isAdmin) {
            setMsg("Ingen tilgang")
            return
          }

          const startIso = elReportStart.value
          const endIso = elReportEnd.value

          if (!startIso || !endIso) {
            setMsg("Velg fra- og til-dato")
            return
          }

          const startDate = parseIsoDate(startIso)
          const endDate = parseIsoDate(endIso)
          if (!startDate || !endDate) {
            setMsg("Ugyldig dato")
            return
          }

          if (startDate >= endDate) {
            setMsg("Til-dato må være etter fra-dato")
            return
          }

          if (!canUsePdfLibs()) {
            setMsg("Fant ikke PDF-bibliotek. Oppdater siden.")
            return
          }

          let bookings = []
          try {
            bookings = await fetchBookingsForReport(startIso, endIso)
          } catch (err) {
            setMsg("Klarte ikke å hente historiske bookinger. Bruker lokal oversikt.")
            bookings = collectBookingsForReport(startIso, endIso)
          }
          bookings.sort((a, b) => {
            const dateCmp = String(a.checkin_date || "").localeCompare(String(b.checkin_date || ""))
            if (dateCmp !== 0) return dateCmp
            return String(a.unit_code || "").localeCompare(String(b.unit_code || ""), "nb")
          })

          const { jsPDF } = window.jspdf
          const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" })

          const pageW = doc.internal.pageSize.getWidth()
          const pageH = doc.internal.pageSize.getHeight()
          const margin = 40

          let y = margin
          doc.setFont("helvetica", "bold")
          doc.setFontSize(14)
          doc.text("Bookingrapport", margin, y)
          y += 18

          doc.setFont("helvetica", "normal")
          doc.setFontSize(10)
          doc.text("Periode: " + fmtRange(startIso, endIso), margin, y)
          y += 14
          doc.text("Antall bookinger: " + bookings.length, margin, y)
          y += 16

          if (bookings.length === 0) {
            doc.text("Ingen bookinger i perioden.", margin, y)
          } else {
            for (const booking of bookings) {
              const line = bookingReportLine(booking)
              const lines = doc.splitTextToSize(line, pageW - margin * 2)
              for (const textLine of lines) {
                if (y > pageH - margin) {
                  doc.addPage()
                  y = margin
                }
                doc.text(textLine, margin, y)
                y += 12
              }
              y += 4
            }
          }

          doc.save("bookingrapport-" + startIso + "-" + endIso + ".pdf")
        } catch {
          setMsg("Klarte ikke å lage PDF")
        }
      }


      let identityReadyResolve
      const identityReady = new Promise((res) => { identityReadyResolve = res })

      async function authHeaders(extra = {}) {
        const ni = window.netlifyIdentity
        const user = ni && ni.currentUser ? ni.currentUser() : null
        if (!user || !user.jwt) return extra
        const token = await user.jwt()
        if (!token) return extra
        return { ...extra, Authorization: "Bearer " + token }
      }

      function applyRoleUi() {
        elBookingCard.style.display = isAdmin ? "block" : "none"
        elWashCard.style.display = isAdmin ? "block" : "none"
        elAdminRequestsCard.style.display = isAdmin ? "block" : "none"
        elRequestCard.style.display = isAdmin ? "none" : "block"
        document.querySelectorAll(".adminOnly").forEach((el) => {
          el.style.display = isAdmin ? "" : "none"
        })
        document.querySelectorAll(".adminOnlyBlock").forEach((el) => {
          el.style.display = isAdmin ? "block" : "none"
        })
      }

      function fillAdminUnitSelect(checkin, checkout) {
        const list = (checkin && checkout) ? availableUnits(checkin, checkout) : unitRows
        elUnitSelect.innerHTML = ""
        if (!checkin || !checkout) {
          elUnitSelect.disabled = true
          const opt = document.createElement("option")
          opt.value = ""
          opt.textContent = "Velg datoer først"
          elUnitSelect.appendChild(opt)
          return
        }

        elUnitSelect.disabled = false
        const opt0 = document.createElement("option")
        opt0.value = ""
        opt0.textContent = "Velg"
        elUnitSelect.appendChild(opt0)

        for (const r of list) {
          const opt = document.createElement("option")
          opt.value = r.unit_id
          opt.textContent = r.unit_code
          elUnitSelect.appendChild(opt)
        }
      }

      async function loadUnits() {
        setMsg("Henter data")

        try {
          await identityReady
          const headers = await authHeaders()
          const res = await fetch("/.netlify/functions/units", { headers })

          if (res.status === 401) {
            window.location.href = "/login/"
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Klarte ikke å hente data. Status " + res.status))
            return
          }

          const payload = await res.json()
          const rows = Array.isArray(payload)
            ? payload
            : (Array.isArray(payload?.rows) ? payload.rows : [])
          unitRows = rows

          setMsg("")
          clearTable()
          renderMap(unitRows)
          for (const rr of unitRows) addRow(rr)

          renderWash(unitRows)
          fillAdminUnitSelect(elCheckin.value, elCheckout.value)

          if (isAdmin) await loadBookingRequests()
        } catch {
          setMsg("Klarte ikke å hente data")
        }
      }

      async function createBooking(e) {
        e.preventDefault()
        setMsg("")

        if (!isAdmin) {
          setMsg("Ingen tilgang")
          return
        }

        const checkinDate = elCheckin.value
        const checkoutDate = elCheckout.value
        const unitId = elUnitSelect.value

        const tenantName = document.getElementById("tenantName").value
        const company = document.getElementById("company").value
        const tenantEmail = document.getElementById("tenantEmail").value
        const tenantPhone = document.getElementById("tenantPhone").value

        if (!unitId || !checkinDate || !checkoutDate) {
          setMsg("Fyll inn datoer og enhet")
          return
        }

        const len = daysBetween(checkinDate, checkoutDate)
        if (!Number.isFinite(len) || len < 7) {
          setMsg("Minimum leieperiode er 7 netter")
          return
        }
        if (!isMondayIso(checkinDate) || !isMondayIso(checkoutDate) || len % 7 !== 0) {
          setMsg("Bookinger må være fra mandag til mandag i hele uker")
          return
        }

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/create-booking", {
            method: "POST",
            headers,
            body: JSON.stringify({
              unit_id: Number(unitId),
              tenant_name: tenantName,
              company: company,
              email: tenantEmail,
              phone: tenantPhone,
              checkin_date: checkinDate,
              checkout_date: checkoutDate
            })
          })

          if (res.status === 401 || res.status === 403) {
            const t = await res.text()
            setMsg(t || "Ingen tilgang")
            return
          }

          if (res.status === 409) {
            setMsg("Konflikt. Enheten er allerede booket i perioden")
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || "Feil ved oppretting")
            return
          }

          setMsg("Booking opprettet")
          document.getElementById("tenantName").value = ""
          document.getElementById("company").value = ""
          document.getElementById("tenantEmail").value = ""
          document.getElementById("tenantPhone").value = ""
          elCheckin.value = ""
          elCheckout.value = ""
          fillAdminUnitSelect("", "")
          updateBookingPriceDisplay()

          await loadUnits()
        } catch {
          setMsg("Feil ved oppretting")
        }
      }

      async function deleteBooking(bookingId) {
        if (!isAdmin) {
          setMsg("Ingen tilgang")
          return
        }

        if (!Number.isFinite(bookingId) || bookingId <= 0) {
          setMsg("Mangler booking id")
          return
        }

        const ok = confirm("Vil du slette denne bookingen?")
        if (!ok) return

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/delete-booking", {
            method: "POST",
            headers,
            body: JSON.stringify({ booking_id: bookingId })
          })

          if (res.status === 401 || res.status === 403) {
            const t = await res.text()
            setMsg(t || "Ingen tilgang")
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Feil ved sletting. Status " + res.status))
            return
          }

          setMsg("Booking slettet")
          await loadUnits()
        } catch {
          setMsg("Feil ved sletting")
        }
      }

      function uid() {
        return Math.random().toString(16).slice(2) + Date.now().toString(16)
      }

      let reqLines = []

      function newReqLine() {
        return {
          _id: uid(),
          checkin_date: "",
          checkout_date: "",
          unit_id: "",
          company: "",
          tenant_name: "",
          comment: ""
        }
      }

      function renderReqLines() {
        elReqLinesTbody.innerHTML = ""

        for (const line of reqLines) {
          const tr = document.createElement("tr")

          const tdIn = document.createElement("td")
          const inEl = document.createElement("input")
          inEl.type = "date"
          inEl.value = line.checkin_date || ""
          inEl.addEventListener("change", () => {
            line.checkin_date = inEl.value
            if (line.unit_id && !isUnitIdAvailableForLine(line.unit_id, line.checkin_date, line.checkout_date)) {
              line.unit_id = ""
            }
            renderReqLines()
          })
          tdIn.appendChild(inEl)
          tr.appendChild(tdIn)

          const tdOut = document.createElement("td")
          const outEl = document.createElement("input")
          outEl.type = "date"
          outEl.value = line.checkout_date || ""
          outEl.addEventListener("change", () => {
            line.checkout_date = outEl.value
            if (line.unit_id && !isUnitIdAvailableForLine(line.unit_id, line.checkin_date, line.checkout_date)) {
              line.unit_id = ""
            }
            renderReqLines()
          })
          tdOut.appendChild(outEl)
          tr.appendChild(tdOut)

          const tdUnit = document.createElement("td")
          const sel = document.createElement("select")

          const ready = line.checkin_date && line.checkout_date
          sel.disabled = !ready

          if (!ready) {
            const opt = document.createElement("option")
            opt.value = ""
            opt.textContent = "Velg datoer først"
            sel.appendChild(opt)
          } else {
            const opt0 = document.createElement("option")
            opt0.value = ""
            opt0.textContent = "Velg"
            sel.appendChild(opt0)

            const avail = availableUnits(line.checkin_date, line.checkout_date)
            for (const r of avail) {
              const opt = document.createElement("option")
              opt.value = String(r.unit_id)
              opt.textContent = r.unit_code
              sel.appendChild(opt)
            }
          }

          sel.value = line.unit_id ? String(line.unit_id) : ""
          sel.addEventListener("change", () => {
            line.unit_id = sel.value
          })

          tdUnit.appendChild(sel)
          tr.appendChild(tdUnit)

          const tdComp = document.createElement("td")
          const compEl = document.createElement("input")
          compEl.value = line.company || ""
          compEl.addEventListener("input", () => { line.company = compEl.value })
          tdComp.appendChild(compEl)
          tr.appendChild(tdComp)

          const tdTen = document.createElement("td")
          const tenEl = document.createElement("input")
          tenEl.value = line.tenant_name || ""
          tenEl.addEventListener("input", () => { line.tenant_name = tenEl.value })
          tdTen.appendChild(tenEl)
          tr.appendChild(tdTen)

          const tdCom = document.createElement("td")
          const comEl = document.createElement("input")
          comEl.value = line.comment || ""
          comEl.addEventListener("input", () => { line.comment = comEl.value })
          tdCom.appendChild(comEl)
          tr.appendChild(tdCom)

          const tdPrice = document.createElement("td")
          tdPrice.className = "priceCell"
          tdPrice.textContent = priceLabel(line.checkin_date, line.checkout_date)
          tr.appendChild(tdPrice)

          const tdRm = document.createElement("td")
          const rmBtn = document.createElement("button")
          rmBtn.type = "button"
          rmBtn.className = "btn btnSmall btnGhost"
          rmBtn.textContent = "Fjern"
          rmBtn.addEventListener("click", () => {
            reqLines = reqLines.filter(x => x._id !== line._id)
            if (reqLines.length === 0) reqLines.push(newReqLine())
            renderReqLines()
          })
          tdRm.appendChild(rmBtn)
          tr.appendChild(tdRm)

          elReqLinesTbody.appendChild(tr)
        }
        
        updateReqDateWarning()
      }

      function updateReqDateWarning() {
        if (!elReqDateWarning) return
        const hasInvalid = reqLines.some((line) => {
          if (!line.checkin_date || !line.checkout_date) return false
          if (!isMondayIso(line.checkin_date) || !isMondayIso(line.checkout_date)) return true
          return !isWholeWeeks(line.checkin_date, line.checkout_date)
        })
        elReqDateWarning.style.display = hasInvalid ? "block" : "none"
      }

      function isUnitIdAvailableForLine(unitId, checkin, checkout) {
        const idNum = Number(unitId)
        if (!Number.isFinite(idNum) || idNum <= 0) return false
        const row = unitRows.find(r => Number(r.unit_id) === idNum)
        if (!row) return false
        return unitIsFree(row, checkin, checkout)
      }

      async function submitBookingRequest(e) {
        e.preventDefault()
        setMsg("")

        if (isAdmin) return
        elReqSuccess.style.display = "none"

        const email = (elReqEmail.value || "").trim()
        const phone = (elReqPhone.value || "").trim()

        if (!email) {
          setMsg("Fyll inn e-post")
          return
        }

        const lines = []
        let invalidLines = false
        for (const l of reqLines) {
          if (!l.checkin_date || !l.checkout_date || !l.unit_id) continue
          const len = daysBetween(l.checkin_date, l.checkout_date)
          if (!Number.isFinite(len) || len < 7 || len % 7 !== 0 || !isMondayIso(l.checkin_date) || !isMondayIso(l.checkout_date)) {
            invalidLines = true
            continue
          }
          lines.push({
            checkin_date: l.checkin_date,
            checkout_date: l.checkout_date,
            unit_id: Number(l.unit_id),
            company: l.company || "",
            tenant_name: l.tenant_name || "",
            comment: l.comment || ""
          })
        }

        if (invalidLines) {
          setMsg("Bookinger må være fra mandag til mandag i hele uker")
          return
        }


        if (lines.length === 0) {
          setMsg("Legg inn minst én gyldig linje")
          return
        }

        try {
          await identityReady
          const headers = await authHeaders({ "Content-Type": "application/json" })

          const res = await fetch("/.netlify/functions/create-booking-request", {
            method: "POST",
            headers,
            body: JSON.stringify({
              email,
              phone,
              lines
            })
          })

          if (res.status === 401) {
            window.location.href = "/login/"
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Feil. Status " + res.status))
            return
          }

          setMsg("")
          elReqSuccess.style.display = "inline-flex"
          reqLines = [newReqLine()]
          renderReqLines()
        } catch {
          setMsg("Feil ved sending")
        }
      }

      function normalizeRequests(raw) {
        const payload = raw && typeof raw === "object" ? raw : null
        const list = Array.isArray(raw) ? raw : (Array.isArray(payload?.lines) ? payload.lines : [])
        const out = []

        for (const r of list) {
          const reqId = r.request_id ?? r.requestId ?? r.id ?? r.request ?? ""
          const created = r.created_at ?? r.createdAt ?? r.created ?? ""
          const email = r.email ?? r.requester_email ?? r.requesterEmail ?? r.requested_by_email ?? r.contact_email ?? ""
          const phone = r.phone ?? r.requester_phone ?? r.requesterPhone ?? r.contact_phone ?? ""
          const linesRaw = r.lines ?? r.request_lines ?? r.requestLines ?? r.items ?? []
          const lines = Array.isArray(linesRaw) ? linesRaw : []

          if (lines.length === 0) {
            out.push({
              request_id: reqId,
              created_at: created,
              email,
              phone,
              line_id: r.line_id ?? r.lineId ?? r.id ?? "",
              status: String(r.status ?? r.state ?? "pending").toLowerCase(),
              unit_code: r.unit_code ?? r.unitCode ?? r.unit ?? "",
              unit_id: r.unit_id ?? r.unitId ?? "",
              checkin_date: r.checkin_date ?? r.checkinDate ?? "",
              checkout_date: r.checkout_date ?? r.checkoutDate ?? "",
              company: r.company ?? "",
              tenant_name: r.tenant_name ?? r.tenantName ?? "",
              comment: r.comment ?? r.notes ?? ""
            })
          } else {
            for (const l of lines) {
              out.push({
                request_id: reqId,
                created_at: created,
                email,
                phone,
                line_id: l.line_id ?? l.lineId ?? l.id ?? "",
                status: String(l.status ?? l.state ?? "pending").toLowerCase(),
                unit_code: l.unit_code ?? l.unitCode ?? l.unit ?? "",
                unit_id: l.unit_id ?? l.unitId ?? "",
                checkin_date: l.checkin_date ?? l.checkinDate ?? "",
                checkout_date: l.checkout_date ?? l.checkoutDate ?? "",
                company: l.company ?? "",
                tenant_name: l.tenant_name ?? l.tenantName ?? "",
                comment: l.comment ?? l.notes ?? ""
              })
            }
          }
        }

        return out
      }

      function statusTextReq(s) {
        const x = String(s || "").toLowerCase()
        if (x === "approved" || x === "godkjent") return "Godkjent"
        if (x === "rejected" || x === "avslatt" || x === "avslått") return "Avslått"
        if (x === "cancelled" || x === "canceled") return "Avbrutt"
        return "Ny"
      }

      async function loadBookingRequests() {
        try {
          const headers = await authHeaders()
          const res = await fetch("/.netlify/functions/list-booking-requests", { headers })

          if (res.status === 401) {
            window.location.href = "/login/"
            return
          }

          if (res.status === 403) {
            elAdminReqTbody.innerHTML = ""
            elReqBadge.style.display = "none"
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Feil ved henting av forespørsler. Status " + res.status))
            return
          }

          const raw = await res.json()
          const lines = normalizeRequests(raw)

          let pending = 0
          for (const l of lines) {
            const st = String(l.status || "").toLowerCase()
            if (st === "pending" || st === "new" || st === "ny") pending++
          }

          if (pending > 0) {
            elReqBadge.textContent = "Forespørsler: " + pending
            elReqBadge.style.display = "inline-flex"
          } else {
            elReqBadge.style.display = "none"
          }

          elAdminReqTbody.innerHTML = ""
          for (const l of lines) {
            const tr = document.createElement("tr")

            const tdA = document.createElement("td")
            const idTxt = (l.request_id ? String(l.request_id) : "")
            const createdTxt = l.created_at ? (" " + String(l.created_at)) : ""
            tdA.textContent = (idTxt || "Forespørsel") + createdTxt
            tr.appendChild(tdA)

            const tdB = document.createElement("td")
            const contact = (l.email ? l.email : "") + (l.phone ? (" " + l.phone) : "")
            tdB.textContent = contact.trim()
            tr.appendChild(tdB)

            const tdC = document.createElement("td")
            tdC.textContent = l.unit_code || ""
            tr.appendChild(tdC)

            const tdD = document.createElement("td")
            tdD.textContent = fmtRange(l.checkin_date, l.checkout_date)
            tr.appendChild(tdD)

            const tdE = document.createElement("td")
            tdE.textContent = l.company || ""
            tr.appendChild(tdE)

            const tdF = document.createElement("td")
            tdF.textContent = l.tenant_name || ""
            tr.appendChild(tdF)

            const tdG = document.createElement("td")
            tdG.textContent = l.comment || ""
            tr.appendChild(tdG)

            const tdH = document.createElement("td")
            tdH.textContent = statusTextReq(l.status)
            tr.appendChild(tdH)

            const tdI = document.createElement("td")

            const st = String(l.status || "").toLowerCase()
            const canDecide = st === "pending" || st === "new" || st === "ny"

            if (canDecide) {
              const okBtn = document.createElement("button")
              okBtn.type = "button"
              okBtn.className = "btn btnSmall btnPrimary"
              okBtn.textContent = "Godkjenn"
              okBtn.addEventListener("click", () => decideLine(l.line_id, "approve"))

              const noBtn = document.createElement("button")
              noBtn.type = "button"
              noBtn.className = "btn btnSmall btnDanger"
              noBtn.style.marginLeft = "8px"
              noBtn.textContent = "Avslå"
              noBtn.addEventListener("click", () => decideLine(l.line_id, "reject"))

              tdI.appendChild(okBtn)
              tdI.appendChild(noBtn)
            } else {
              tdI.textContent = ""
            }

            tr.appendChild(tdI)
            elAdminReqTbody.appendChild(tr)
          }
        } catch {
          setMsg("Feil ved henting av forespørsler")
        }
      }

      async function decideLine(lineId, action) {
        if (!isAdmin) return
        if (!lineId) {
          setMsg("Mangler linje-id")
          return
        }

        const ok = confirm(action === "approve" ? "Godkjenne linjen?" : "Avslå linjen?")
        if (!ok) return

        try {
          const headers = await authHeaders({ "Content-Type": "application/json" })
          const res = await fetch("/.netlify/functions/decide-booking-request-line", {
            method: "POST",
            headers,
            body: JSON.stringify({
              line_id: lineId,
              action: action,
              decision: action
            })
          })

          if (res.status === 401) {
            window.location.href = "/login/"
            return
          }

          if (!res.ok) {
            const t = await res.text()
            setMsg(t || ("Feil. Status " + res.status))
            return
          }

          setMsg(action === "approve" ? "Godkjent" : "Avslått")
          await loadUnits()
        } catch {
          setMsg("Feil ved behandling")
        }
      }

      function logout() {
        const ni = window.netlifyIdentity
        if (!ni) return
        ni.logout()
        window.location.href = "/login/"
      }

      function initIdentity() {
        const ni = window.netlifyIdentity
        if (!ni) {
          setMsg("Fant ikke innloggingsmodulen")
          return
        }

        ni.on("init", (user) => {
          if (!user) {
            window.location.href = "/login/"
            return
          }

          elWho.textContent = user.email || ""

          const rolesRaw = user?.app_metadata?.roles || []
          const roles = Array.isArray(rolesRaw) ? rolesRaw.map(r => String(r).toLowerCase()) : []
          isAdmin = roles.includes("admin")

          elReqEmail.value = user.email || ""
          applyRoleUi()

          identityReadyResolve(user)
        })

        ni.on("logout", () => {
          window.location.href = "/login/"
        })

        ni.init()
      }

      document.getElementById("refreshBtn").addEventListener("click", loadUnits)
      document.getElementById("logoutBtn").addEventListener("click", logout)
      document.getElementById("form").addEventListener("submit", createBooking)

      document.getElementById("addReqLineBtn").addEventListener("click", () => {
        reqLines.push(newReqLine())
        renderReqLines()
      })
      document.getElementById("reqForm").addEventListener("submit", submitBookingRequest)

      elCheckin.addEventListener("change", () => {
        fillAdminUnitSelect(elCheckin.value, elCheckout.value)
        updateBookingPriceDisplay()
      })
      elCheckout.addEventListener("change", () => {
        fillAdminUnitSelect(elCheckin.value, elCheckout.value)
        updateBookingPriceDisplay()
      })

      document.getElementById("printWashBtn").addEventListener("click", printWashPlan)
      elReportBtn.addEventListener("click", generateBookingReport)

      reqLines = [newReqLine()]
      renderReqLines()
      updateBookingPriceDisplay()

      initIdentity()
      identityReady.then(() => loadUnits())
    </script>
  </body>
</html>
